# 對帳與交易歷史測試指南

## 功能概述

本系統實作了以下核心功能：

1. **自動對帳 (Reconciliation)** - 跟隨者倉位與 Master 倉位自動同步
2. **補單機制** - 當跟隨者倉位小於目標倉位時，自動買入補足
3. **平倉機制** - 當跟隨者倉位大於目標倉位時，自動賣出減少
4. **倉位追蹤** - 記錄每個跟隨者的當前倉位狀態
5. **交易歷史查詢** - 查詢所有交易記錄，支援多種篩選條件

---

## 測試前準備

### 1. 確認服務運行
```powershell
docker ps
```
應該看到 `ea_trading_backend` 容器正在運行

### 2. 確認資料庫遷移
```powershell
docker exec ea_trading_backend alembic current
```
應該顯示 `006 (head)`

---

## 測試場景

### 場景 1：首次建立倉位（補單）

**目標**：測試當 Master 開倉時，Follower 自動跟單

#### 步驟 1：登入並獲取 Token
```powershell
$loginResponse = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/auth/login" `
    -Method POST `
    -ContentType "application/x-www-form-urlencoded" `
    -Body @{
        username = "testuser"
        password = "testpass123"
    }

$token = $loginResponse.access_token
$headers = @{
    "Authorization" = "Bearer $token"
}
```

#### 步驟 2：創建跟單設定
```powershell
$followSettings = @{
    master_user_id = 1
    master_credential_id = 1
    follower_credential_id = 2
    follow_ratio = 0.1
    is_active = $true
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8000/api/v1/follow-config/settings" `
    -Method POST `
    -Headers $headers `
    -ContentType "application/json" `
    -Body $followSettings
```

#### 步驟 3：Master 開倉
```powershell
$masterPosition = @{
    master_user_id = 1
    master_credential_id = 1
    symbol = "BTC/USDT"
    position_size = 1.0
    entry_price = 50000.0
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8000/api/v1/follower/master-position" `
    -Method POST `
    -Headers $headers `
    -ContentType "application/json" `
    -Body $masterPosition
```

#### 步驟 4：等待 3 秒後檢查狀態
```powershell
Start-Sleep -Seconds 3

$status = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/follow-config/status" `
    -Method GET `
    -Headers $headers

Write-Host "=== 跟單狀態 ===" -ForegroundColor Green
Write-Host "Master 倉位: $($status.master_positions[0].position_size)"
Write-Host "預期 Follower 倉位: $($status.master_positions[0].expected_follower_size)"
Write-Host "實際 Follower 倉位: $($status.my_positions[0].position_size)"
```

**預期結果**：
- Master 倉位：1.0 BTC
- 預期 Follower 倉位：0.1 BTC (1.0 × 0.1)
- 實際 Follower 倉位：0.1 BTC
- 操作類型：補單_增加倉位

---

### 場景 2：Master 加倉（補單）

**目標**：測試當 Master 增加倉位時，Follower 自動補單

#### 步驟 1：Master 加倉到 2.0 BTC
```powershell
$masterPosition = @{
    master_user_id = 1
    master_credential_id = 1
    symbol = "BTC/USDT"
    position_size = 2.0
    entry_price = 50000.0
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8000/api/v1/follower/master-position" `
    -Method POST `
    -Headers $headers `
    -ContentType "application/json" `
    -Body $masterPosition
```

#### 步驟 2：等待 3 秒後檢查狀態
```powershell
Start-Sleep -Seconds 3

$status = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/follow-config/status" `
    -Method GET `
    -Headers $headers

Write-Host "=== 對帳結果 ===" -ForegroundColor Green
Write-Host "Master 倉位: $($status.master_positions[0].position_size)"
Write-Host "預期 Follower 倉位: $($status.master_positions[0].expected_follower_size)"
Write-Host "實際 Follower 倉位: $($status.my_positions[0].position_size)"
```

**預期結果**：
- Master 倉位：2.0 BTC
- 預期 Follower 倉位：0.2 BTC (2.0 × 0.1)
- 實際 Follower 倉位：0.2 BTC
- 調整數量：+0.1 BTC
- 操作類型：補單_增加倉位

---

### 場景 3：Master 減倉（平倉）

**目標**：測試當 Master 減少倉位時，Follower 自動平倉

#### 步驟 1：Master 減倉到 0.5 BTC
```powershell
$masterPosition = @{
    master_user_id = 1
    master_credential_id = 1
    symbol = "BTC/USDT"
    position_size = 0.5
    entry_price = 50000.0
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8000/api/v1/follower/master-position" `
    -Method POST `
    -Headers $headers `
    -ContentType "application/json" `
    -Body $masterPosition
```

#### 步驟 2：等待 3 秒後檢查狀態
```powershell
Start-Sleep -Seconds 3

$status = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/follow-config/status" `
    -Method GET `
    -Headers $headers

Write-Host "=== 對帳結果 ===" -ForegroundColor Green
Write-Host "Master 倉位: $($status.master_positions[0].position_size)"
Write-Host "預期 Follower 倉位: $($status.master_positions[0].expected_follower_size)"
Write-Host "實際 Follower 倉位: $($status.my_positions[0].position_size)"
```

**預期結果**：
- Master 倉位：0.5 BTC
- 預期 Follower 倉位：0.05 BTC (0.5 × 0.1)
- 實際 Follower 倉位：0.05 BTC
- 調整數量：-0.15 BTC
- 操作類型：平倉_減少倉位

---

### 場景 4：查詢交易歷史

**目標**：測試交易歷史查詢功能

#### 查詢所有交易記錄
```powershell
$history = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/trades/history" `
    -Method GET `
    -Headers $headers

Write-Host "=== 交易歷史 ===" -ForegroundColor Green
foreach ($trade in $history) {
    Write-Host "`n交易 ID: $($trade.id)"
    Write-Host "時間: $($trade.timestamp)"
    Write-Host "交易對: $($trade.master_symbol)"
    Write-Host "操作: $($trade.follower_action)"
    Write-Host "方向: $($trade.side)"
    Write-Host "數量: $($trade.follower_amount)"
    Write-Host "狀態: $($trade.status)"
    Write-Host "成功: $($trade.is_success)"
    Write-Host "執行時間: $($trade.execution_time_ms) ms"
}
```

#### 按交易對篩選
```powershell
$history = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/trades/history?symbol=BTC/USDT" `
    -Method GET `
    -Headers $headers
```

#### 按狀態篩選
```powershell
# 只查詢成功的交易
$history = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/trades/history?status=success" `
    -Method GET `
    -Headers $headers

# 只查詢失敗的交易
$history = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/trades/history?status=failed" `
    -Method GET `
    -Headers $headers
```

#### 按日期範圍篩選
```powershell
$startDate = (Get-Date).AddDays(-7).ToString("yyyy-MM-ddTHH:mm:ss")
$endDate = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ss")

$history = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/trades/history?start_date=$startDate&end_date=$endDate" `
    -Method GET `
    -Headers $headers
```

#### 分頁查詢
```powershell
# 每頁 10 筆，查詢第 1 頁
$history = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/trades/history?limit=10&offset=0" `
    -Method GET `
    -Headers $headers

# 查詢第 2 頁
$history = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/trades/history?limit=10&offset=10" `
    -Method GET `
    -Headers $headers
```

---

## 完整測試腳本

創建 `test_reconciliation.ps1` 檔案：

```powershell
# 對帳與交易歷史完整測試腳本

Write-Host "=== EA Trading 對帳系統測試 ===" -ForegroundColor Cyan

# 1. 登入
Write-Host "`n[1/6] 登入系統..." -ForegroundColor Yellow
$loginResponse = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/auth/login" `
    -Method POST `
    -ContentType "application/x-www-form-urlencoded" `
    -Body @{
        username = "testuser"
        password = "testpass123"
    }

$token = $loginResponse.access_token
$headers = @{
    "Authorization" = "Bearer $token"
}
Write-Host "✓ 登入成功" -ForegroundColor Green

# 2. 創建跟單設定
Write-Host "`n[2/6] 創建跟單設定..." -ForegroundColor Yellow
$followSettings = @{
    master_user_id = 1
    master_credential_id = 1
    follower_credential_id = 2
    follow_ratio = 0.1
    is_active = $true
} | ConvertTo-Json

try {
    Invoke-RestMethod -Uri "http://localhost:8000/api/v1/follow-config/settings" `
        -Method POST `
        -Headers $headers `
        -ContentType "application/json" `
        -Body $followSettings
    Write-Host "✓ 跟單設定創建成功" -ForegroundColor Green
} catch {
    Write-Host "✓ 跟單設定已存在" -ForegroundColor Green
}

# 3. Master 開倉 1.0 BTC
Write-Host "`n[3/6] Master 開倉 1.0 BTC..." -ForegroundColor Yellow
$masterPosition = @{
    master_user_id = 1
    master_credential_id = 1
    symbol = "BTC/USDT"
    position_size = 1.0
    entry_price = 50000.0
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8000/api/v1/follower/master-position" `
    -Method POST `
    -Headers $headers `
    -ContentType "application/json" `
    -Body $masterPosition

Write-Host "等待 3 秒讓系統處理..." -ForegroundColor Gray
Start-Sleep -Seconds 3

$status = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/follow-config/status" `
    -Method GET `
    -Headers $headers

Write-Host "✓ Master: 1.0 BTC → Follower: $($status.my_positions[0].position_size) BTC" -ForegroundColor Green

# 4. Master 加倉到 2.0 BTC
Write-Host "`n[4/6] Master 加倉到 2.0 BTC..." -ForegroundColor Yellow
$masterPosition = @{
    master_user_id = 1
    master_credential_id = 1
    symbol = "BTC/USDT"
    position_size = 2.0
    entry_price = 50000.0
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8000/api/v1/follower/master-position" `
    -Method POST `
    -Headers $headers `
    -ContentType "application/json" `
    -Body $masterPosition

Write-Host "等待 3 秒讓系統處理..." -ForegroundColor Gray
Start-Sleep -Seconds 3

$status = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/follow-config/status" `
    -Method GET `
    -Headers $headers

Write-Host "✓ Master: 2.0 BTC → Follower: $($status.my_positions[0].position_size) BTC" -ForegroundColor Green

# 5. Master 減倉到 0.5 BTC
Write-Host "`n[5/6] Master 減倉到 0.5 BTC..." -ForegroundColor Yellow
$masterPosition = @{
    master_user_id = 1
    master_credential_id = 1
    symbol = "BTC/USDT"
    position_size = 0.5
    entry_price = 50000.0
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8000/api/v1/follower/master-position" `
    -Method POST `
    -Headers $headers `
    -ContentType "application/json" `
    -Body $masterPosition

Write-Host "等待 3 秒讓系統處理..." -ForegroundColor Gray
Start-Sleep -Seconds 3

$status = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/follow-config/status" `
    -Method GET `
    -Headers $headers

Write-Host "✓ Master: 0.5 BTC → Follower: $($status.my_positions[0].position_size) BTC" -ForegroundColor Green

# 6. 查詢交易歷史
Write-Host "`n[6/6] 查詢交易歷史..." -ForegroundColor Yellow
$history = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/trades/history?limit=10" `
    -Method GET `
    -Headers $headers

Write-Host "✓ 找到 $($history.Count) 筆交易記錄" -ForegroundColor Green

Write-Host "`n=== 最近 5 筆交易 ===" -ForegroundColor Cyan
$history | Select-Object -First 5 | ForEach-Object {
    Write-Host "`n[$($_.timestamp)]" -ForegroundColor Gray
    Write-Host "  操作: $($_.follower_action)" -ForegroundColor White
    Write-Host "  方向: $($_.side) | 數量: $($_.follower_amount)" -ForegroundColor White
    Write-Host "  狀態: $($_.status) | 成功: $($_.is_success)" -ForegroundColor $(if ($_.is_success) { "Green" } else { "Red" })
}

Write-Host "`n=== 測試完成 ===" -ForegroundColor Cyan
```

---

## 驗證重點

### 1. 對帳邏輯
- ✅ 當前倉位 < 目標倉位 → 執行補單（buy）
- ✅ 當前倉位 > 目標倉位 → 執行平倉（sell）
- ✅ 當前倉位 = 目標倉位 → 不執行操作

### 2. 倉位計算
- ✅ 目標倉位 = Master 倉位 × follow_ratio
- ✅ 調整數量 = 目標倉位 - 當前倉位

### 3. 錯誤處理
- ✅ 交易失敗時自動停止跟單
- ✅ 記錄錯誤詳情到 trade_errors 表
- ✅ 解決錯誤後可恢復跟單

### 4. 交易記錄
- ✅ 每次對帳操作都記錄到 trade_logs
- ✅ 記錄執行時間、狀態、錯誤訊息
- ✅ 支援多種篩選條件查詢

---

## 常見問題

### Q1：為什麼 Follower 倉位沒有更新？
**A**：檢查以下幾點：
1. 跟單設定的 `is_active` 是否為 `true`
2. 是否有未解決的錯誤（檢查 `/api/v1/follow-config/errors`）
3. 等待至少 3 秒讓監控循環執行

### Q2：如何查看詳細的對帳日誌？
**A**：查看 Docker 容器日誌：
```powershell
docker logs ea_trading_backend --tail 100
```

### Q3：如何重置測試環境？
**A**：清空相關資料表：
```powershell
docker exec -it ea_trading_postgres psql -U postgres -d ea_trading -c "
TRUNCATE TABLE follower_positions, trade_logs, trade_errors, follow_settings CASCADE;
"
```

---

## API 端點總覽

### 跟單配置
- `POST /api/v1/follow-config/settings` - 創建跟單設定
- `GET /api/v1/follow-config/settings` - 獲取我的設定
- `PUT /api/v1/follow-config/settings` - 更新我的設定
- `GET /api/v1/follow-config/status` - 獲取跟單狀態（含倉位對比）
- `GET /api/v1/follow-config/errors` - 獲取我的錯誤
- `POST /api/v1/follow-config/errors/{id}/resolve` - 解決錯誤

### 交易歷史
- `GET /api/v1/trades/history` - 查詢交易歷史
  - 參數：`symbol`, `status`, `start_date`, `end_date`, `limit`, `offset`

### Master 倉位管理
- `POST /api/v1/follower/master-position` - 更新 Master 倉位

---

## 下一步

1. 測試多個交易對的同時對帳
2. 測試高頻率的倉位變動
3. 測試錯誤恢復流程
4. 壓力測試：多個 Follower 同時跟單
