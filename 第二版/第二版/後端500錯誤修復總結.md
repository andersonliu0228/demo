# å¾Œç«¯ 500 éŒ¯èª¤ä¿®å¾©ç¸½çµ

## ğŸ¯ ä¿®å¾©ç›®æ¨™
å¾¹åº•è§£æ±ºå¾Œç«¯ç™»å…¥ 500 éŒ¯èª¤ï¼Œç¢ºä¿ç³»çµ±ç©©å®šé‹è¡Œ

---

## ğŸ” å¸¸è¦‹ 500 éŒ¯èª¤åŸå› 

### 1. æ•¸æ“šåº«æœªåˆå§‹åŒ–
- **ç—‡ç‹€**ï¼š`relation "users" does not exist`
- **åŸå› **ï¼šå®¹å™¨é‡å•Ÿå¾Œæ•¸æ“šè¡¨ä¸Ÿå¤±
- **è§£æ±º**ï¼šentrypoint.sh ä¸­å·²åŒ…å« `alembic upgrade head`

### 2. ç’°å¢ƒè®Šæ•¸ç¼ºå¤±
- **ç—‡ç‹€**ï¼š`SECRET_KEY not found` æˆ–é…ç½®éŒ¯èª¤
- **åŸå› **ï¼š.env æ–‡ä»¶æœªæ­£ç¢ºè¼‰å…¥
- **è§£æ±º**ï¼šæ·»åŠ é…ç½®é©—è­‰ï¼Œå•Ÿå‹•æ™‚æª¢æŸ¥é—œéµè®Šæ•¸

### 3. å¯†ç¢¼åŠ å¯†å•é¡Œ
- **ç—‡ç‹€**ï¼š`ValueError: Invalid salt` æˆ–å¯†ç¢¼é©—è­‰å¤±æ•—
- **åŸå› **ï¼šbcrypt é…ç½®éŒ¯èª¤æˆ–ç‰ˆæœ¬ä¸åŒ¹é…
- **è§£æ±º**ï¼šç¢ºä¿ passlib æ­£ç¢ºåˆå§‹åŒ–

### 4. æ•¸æ“šåº«é€£æ¥å¤±æ•—
- **ç—‡ç‹€**ï¼š`could not connect to server`
- **åŸå› **ï¼šPostgreSQL æœªå°±ç·’æˆ–é€£æ¥é…ç½®éŒ¯èª¤
- **è§£æ±º**ï¼šentrypoint.sh ç­‰å¾…æ•¸æ“šåº«å°±ç·’

---

## âœ… å·²å¯¦æ–½çš„ä¿®å¾©

### 1. å¼·åŒ–é…ç½®é©—è­‰ï¼ˆconfig.pyï¼‰

#### æ–°å¢åŠŸèƒ½
```python
def validate_settings(self):
    """é©—è­‰é—œéµè¨­å®š"""
    errors = []
    
    if not self.SECRET_KEY or self.SECRET_KEY == "your-secret-key-change-in-production":
        errors.append("âš ï¸  WARNING: JWT_SECRET_KEY æœªè¨­ç½®æˆ–ä½¿ç”¨é è¨­å€¼")
    
    if not self.ENCRYPTION_KEY or self.ENCRYPTION_KEY == "your-base64-encoded-fernet-key-here":
        errors.append("âš ï¸  WARNING: ENCRYPTION_KEY æœªè¨­ç½®æˆ–ä½¿ç”¨é è¨­å€¼")
    
    if not self.DATABASE_URL:
        errors.append("âŒ ERROR: DATABASE_URL æœªè¨­ç½®")
    
    if not self.REDIS_URL:
        errors.append("âŒ ERROR: REDIS_URL æœªè¨­ç½®")
    
    return len([e for e in errors if e.startswith("âŒ")]) == 0

# å•Ÿå‹•æ™‚è‡ªå‹•é©—è­‰
if not settings.validate_settings():
    raise ValueError("é—œéµé…ç½®ç¼ºå¤±ï¼Œç„¡æ³•å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼")
```

**æ•ˆæœ**ï¼š
- âœ… å•Ÿå‹•æ™‚è‡ªå‹•æª¢æŸ¥é…ç½®
- âœ… æ˜ç¢ºæŒ‡å‡ºç¼ºå¤±çš„é…ç½®
- âœ… é˜²æ­¢ä½¿ç”¨ä¸å®‰å…¨çš„é è¨­å€¼

### 2. å¼·åŒ–å¯†ç¢¼åŠ å¯†åˆå§‹åŒ–ï¼ˆauth_service.pyï¼‰

#### ä¿®æ”¹å‰
```python
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
```

#### ä¿®æ”¹å¾Œ
```python
try:
    pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
    logger.info("âœ… Passlib bcrypt åˆå§‹åŒ–æˆåŠŸ")
except Exception as e:
    logger.error(f"âŒ Passlib bcrypt åˆå§‹åŒ–å¤±æ•—: {e}")
    raise
```

**æ•ˆæœ**ï¼š
- âœ… æ•ç² bcrypt åˆå§‹åŒ–éŒ¯èª¤
- âœ… æä¾›æ˜ç¢ºçš„éŒ¯èª¤è¨Šæ¯
- âœ… é˜²æ­¢éœé»˜å¤±æ•—

### 3. å¼·åŒ–ç™»å…¥éŒ¯èª¤è™•ç†ï¼ˆauth_routes.pyï¼‰

#### æ–°å¢è©³ç´°æ—¥èªŒ
```python
@router.post("/login", response_model=Token)
async def login(form_data, auth_service):
    try:
        logger.info(f"ğŸ” ç™»å…¥è«‹æ±‚: username={form_data.username}")
        
        user = await auth_service.authenticate_user(...)
        
        if not user:
            logger.warning(f"âŒ ç™»å…¥å¤±æ•—: ç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤")
            raise HTTPException(...)
        
        logger.info(f"âœ… ç”¨æˆ¶é©—è­‰æˆåŠŸ: {user.username}, is_active={user.is_active}")
        
        access_token = auth_service.create_access_token(...)
        
        logger.info(f"âœ… Token ç”ŸæˆæˆåŠŸ: expires_in={settings.ACCESS_TOKEN_EXPIRE_MINUTES}min")
        
        return Token(access_token=access_token, token_type="bearer")
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"âŒ ç™»å…¥éŒ¯èª¤: {str(e)}", exc_info=True)
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"ç™»å…¥å¤±æ•—: {str(e)}"  # åŒ…å«éŒ¯èª¤è©³æƒ…
        )
```

**æ•ˆæœ**ï¼š
- âœ… æ¯å€‹æ­¥é©Ÿéƒ½æœ‰æ—¥èªŒ
- âœ… éŒ¯èª¤è¨Šæ¯åŒ…å«è©³ç´°è³‡è¨Š
- âœ… ä¾¿æ–¼å¿«é€Ÿå®šä½å•é¡Œ

### 4. ç¢ºä¿æ•¸æ“šåº«é·ç§»ï¼ˆentrypoint.shï¼‰

```bash
#!/bin/bash
set -e

echo "ç­‰å¾… PostgreSQL å•Ÿå‹•..."
while ! pg_isready -h $POSTGRES_HOST -p 5432 -U $POSTGRES_USER; do
  sleep 1
done

echo "PostgreSQL å·²å°±ç·’"

echo "åŸ·è¡Œè³‡æ–™åº«é·ç§»..."
alembic upgrade head

echo "å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼..."
exec "$@"
```

**æ•ˆæœ**ï¼š
- âœ… è‡ªå‹•ç­‰å¾…æ•¸æ“šåº«å°±ç·’
- âœ… è‡ªå‹•åŸ·è¡Œé·ç§»
- âœ… ç¢ºä¿è¡¨çµæ§‹æ­£ç¢º

### 5. å»¶é•· Token æœ‰æ•ˆæœŸ

```python
ACCESS_TOKEN_EXPIRE_MINUTES: int = 1440  # 24 å°æ™‚ï¼ˆåŸæœ¬ 30 åˆ†é˜ï¼‰
```

**æ•ˆæœ**ï¼š
- âœ… æ¸›å°‘é »ç¹ç™»å‡º
- âœ… æ”¹å–„ç”¨æˆ¶é«”é©—

---

## ğŸ§ª è¨ºæ–·æµç¨‹

### æ­¥é©Ÿ 1ï¼šæª¢æŸ¥å¾Œç«¯æ—¥èªŒ
```bash
docker logs --tail=100 ea_trading_backend
```

**æŸ¥æ‰¾é—œéµè¨Šæ¯**ï¼š
- âŒ `relation "users" does not exist` â†’ æ•¸æ“šåº«æœªåˆå§‹åŒ–
- âŒ `SECRET_KEY not found` â†’ ç’°å¢ƒè®Šæ•¸ç¼ºå¤±
- âŒ `Invalid salt` â†’ å¯†ç¢¼åŠ å¯†å•é¡Œ
- âŒ `could not connect to server` â†’ æ•¸æ“šåº«é€£æ¥å¤±æ•—
- âœ… `âœ… Passlib bcrypt åˆå§‹åŒ–æˆåŠŸ` â†’ åŠ å¯†æ­£å¸¸
- âœ… `âœ… é…ç½®é©—è­‰é€šé` â†’ é…ç½®æ­£å¸¸

### æ­¥é©Ÿ 2ï¼šæª¢æŸ¥ç’°å¢ƒè®Šæ•¸
```bash
check-env-vars.bat
```

**ç¢ºèªä»¥ä¸‹è®Šæ•¸å­˜åœ¨**ï¼š
- `DATABASE_URL`
- `REDIS_URL`
- `ENCRYPTION_KEY`
- `JWT_SECRET_KEY` æˆ– `SECRET_KEY`

### æ­¥é©Ÿ 3ï¼šæ¸¬è©¦æ•¸æ“šåº«é€£æ¥
```bash
docker exec ea_trading_postgres pg_isready -U postgres
```

**é æœŸè¼¸å‡º**ï¼š
```
/var/run/postgresql:5432 - accepting connections
```

### æ­¥é©Ÿ 4ï¼šæª¢æŸ¥æ•¸æ“šè¡¨
```bash
docker exec -it ea_trading_postgres psql -U postgres -d ea_trading -c "\dt"
```

**æ‡‰è©²çœ‹åˆ°**ï¼š
- users
- api_credentials
- follow_relationships
- master_positions
- follower_positions
- trade_history
- trade_logs
- trade_errors
- follow_settings
- position_snapshots

### æ­¥é©Ÿ 5ï¼šæ¸¬è©¦ç™»å…¥ API
```bash
curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=testuser&password=testpass123"
```

**æˆåŠŸéŸ¿æ‡‰**ï¼š
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "token_type": "bearer"
}
```

**å¤±æ•—éŸ¿æ‡‰**ï¼š
```json
{
  "detail": "ç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤"
}
```

---

## ğŸ”§ å®Œæ•´ä¿®å¾©æµç¨‹

### ä½¿ç”¨è‡ªå‹•åŒ–è…³æœ¬
```bash
fix-backend-500.bat
```

### æ‰‹å‹•ä¿®å¾©æ­¥é©Ÿ

#### 1. åœæ­¢æ‰€æœ‰å®¹å™¨
```bash
docker-compose down
```

#### 2. æ¸…ç† volumeï¼ˆå¯é¸ï¼Œæœƒåˆªé™¤æ•¸æ“šï¼‰
```bash
docker volume rm ea-trading_postgres_data ea-trading_redis_data
```

#### 3. é‡æ–°æ§‹å»ºå¾Œç«¯
```bash
docker-compose build backend
```

#### 4. å•Ÿå‹•æ•¸æ“šåº«
```bash
docker-compose up -d postgres redis
```

ç­‰å¾… 15 ç§’è®“æ•¸æ“šåº«å®Œå…¨å•Ÿå‹•

#### 5. å•Ÿå‹•å¾Œç«¯
```bash
docker-compose up -d backend
```

ç­‰å¾… 20 ç§’è®“å¾Œç«¯å®Œå…¨å•Ÿå‹•

#### 6. æª¢æŸ¥æ—¥èªŒ
```bash
docker logs --tail=50 ea_trading_backend
```

æŸ¥æ‰¾ï¼š
- âœ… `PostgreSQL å·²å°±ç·’`
- âœ… `åŸ·è¡Œè³‡æ–™åº«é·ç§»...`
- âœ… `âœ… Passlib bcrypt åˆå§‹åŒ–æˆåŠŸ`
- âœ… `Application startup complete`

#### 7. åˆå§‹åŒ–æ¸¬è©¦æ•¸æ“š
```bash
docker exec ea_trading_backend python scripts/init_test_data.py
```

#### 8. æ¸¬è©¦ç™»å…¥
```bash
curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=testuser&password=testpass123"
```

#### 9. å•Ÿå‹•å‰ç«¯
```bash
docker-compose up -d frontend
```

---

## ğŸ› å¸¸è¦‹å•é¡Œæ’æŸ¥

### å•é¡Œ 1ï¼šæ•¸æ“šè¡¨ä¸å­˜åœ¨

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedTable) relation "users" does not exist
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
# æ‰‹å‹•åŸ·è¡Œé·ç§»
docker exec ea_trading_backend alembic upgrade head

# æª¢æŸ¥è¡¨æ˜¯å¦å‰µå»º
docker exec -it ea_trading_postgres psql -U postgres -d ea_trading -c "\dt"
```

### å•é¡Œ 2ï¼šç’°å¢ƒè®Šæ•¸æœªè¼‰å…¥

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
pydantic_core._pydantic_core.ValidationError: 1 validation error for Settings
DATABASE_URL
  Field required
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèª .env æ–‡ä»¶å­˜åœ¨ï¼š
   ```bash
   if not exist .env copy .env.example .env
   ```

2. æª¢æŸ¥ docker-compose.yml ä¸­çš„ç’°å¢ƒè®Šæ•¸ï¼š
   ```yaml
   environment:
     DATABASE_URL: postgresql+asyncpg://postgres:postgres@postgres:5432/ea_trading
     REDIS_URL: redis://redis:6379/0
     ENCRYPTION_KEY: ${ENCRYPTION_KEY:-your-base64-encoded-fernet-key-here}
     JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-secret-key-change-in-production}
   ```

3. é‡å•Ÿå®¹å™¨ï¼š
   ```bash
   docker-compose restart backend
   ```

### å•é¡Œ 3ï¼šå¯†ç¢¼é©—è­‰å¤±æ•—

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
ValueError: Invalid salt
```

**å¯èƒ½åŸå› **ï¼š
1. æ•¸æ“šåº«ä¸­çš„å¯†ç¢¼é›œæ¹Šæ ¼å¼éŒ¯èª¤
2. bcrypt ç‰ˆæœ¬ä¸åŒ¹é…
3. passlib é…ç½®éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
# é‡æ–°åˆå§‹åŒ–æ¸¬è©¦æ•¸æ“š
docker exec ea_trading_backend python scripts/init_test_data.py

# æª¢æŸ¥ç”¨æˆ¶å¯†ç¢¼é›œæ¹Š
docker exec -it ea_trading_postgres psql -U postgres -d ea_trading -c "SELECT username, substring(hashed_password, 1, 10) FROM users;"
```

æ‡‰è©²çœ‹åˆ°é¡ä¼¼ï¼š
```
 username  | substring  
-----------+------------
 testuser  | $2b$12$...
```

`$2b$` è¡¨ç¤º bcrypt é›œæ¹Š

### å•é¡Œ 4ï¼šToken ç”Ÿæˆå¤±æ•—

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
jose.exceptions.JWTError: ...
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥ SECRET_KEYï¼š
   ```bash
   docker exec ea_trading_backend python -c "from backend.app.config import settings; print(f'SECRET_KEY: {settings.SECRET_KEY[:20]}...')"
   ```

2. ç¢ºä¿ SECRET_KEY ä¸ç‚ºç©ºä¸”è¶³å¤ é•·ï¼ˆå»ºè­° 32+ å­—ç¬¦ï¼‰

3. é‡æ–°ç”Ÿæˆ SECRET_KEYï¼š
   ```bash
   python -c "import secrets; print(secrets.token_urlsafe(32))"
   ```

---

## âœ… é©—è­‰æ¸…å–®

å®Œæˆä»¥ä¸‹æ‰€æœ‰é …ç›®ï¼Œç¢ºèªå¾Œç«¯æ­£å¸¸é‹è¡Œï¼š

- [ ] å¾Œç«¯å®¹å™¨æ­£å¸¸é‹è¡Œï¼ˆ`docker ps`ï¼‰
- [ ] æ•¸æ“šåº«é€£æ¥æˆåŠŸï¼ˆ`pg_isready`ï¼‰
- [ ] æ•¸æ“šè¡¨å·²å‰µå»ºï¼ˆ`\dt`ï¼‰
- [ ] ç’°å¢ƒè®Šæ•¸æ­£ç¢ºè¼‰å…¥ï¼ˆ`check-env-vars.bat`ï¼‰
- [ ] é…ç½®é©—è­‰é€šéï¼ˆæ—¥èªŒä¸­æœ‰ `âœ… é…ç½®é©—è­‰é€šé`ï¼‰
- [ ] Bcrypt åˆå§‹åŒ–æˆåŠŸï¼ˆæ—¥èªŒä¸­æœ‰ `âœ… Passlib bcrypt åˆå§‹åŒ–æˆåŠŸ`ï¼‰
- [ ] å¥åº·æª¢æŸ¥é€šéï¼ˆ`curl http://localhost:8000/health`ï¼‰
- [ ] æ¸¬è©¦ç”¨æˆ¶å­˜åœ¨ï¼ˆ`init_test_data.py`ï¼‰
- [ ] ç™»å…¥ API è¿”å› 200ï¼ˆä¸æ˜¯ 500ï¼‰
- [ ] ç™»å…¥æˆåŠŸè¿”å› access_token
- [ ] å‰ç«¯å¯ä»¥æˆåŠŸç™»å…¥

---

## ğŸ“Š ä¿®å¾©å‰å¾Œå°æ¯”

### ä¿®å¾©å‰
- âŒ é…ç½®éŒ¯èª¤éœé»˜å¤±æ•—
- âŒ éŒ¯èª¤è¨Šæ¯ä¸æ˜ç¢º
- âŒ é›£ä»¥å®šä½å•é¡Œ
- âŒ Token æœ‰æ•ˆæœŸå¤ªçŸ­ï¼ˆ30åˆ†é˜ï¼‰

### ä¿®å¾©å¾Œ
- âœ… å•Ÿå‹•æ™‚è‡ªå‹•é©—è­‰é…ç½®
- âœ… è©³ç´°çš„éŒ¯èª¤æ—¥èªŒ
- âœ… æ¯å€‹æ­¥é©Ÿéƒ½æœ‰ç‹€æ…‹è¼¸å‡º
- âœ… Token æœ‰æ•ˆæœŸå»¶é•·ï¼ˆ24å°æ™‚ï¼‰
- âœ… è‡ªå‹•åŒ–è¨ºæ–·å’Œä¿®å¾©è…³æœ¬

---

## ğŸš€ å¿«é€Ÿæ¸¬è©¦

åŸ·è¡Œå®Œæ•´ä¿®å¾©å’Œæ¸¬è©¦ï¼š
```bash
fix-backend-500.bat
```

åªæª¢æŸ¥ç’°å¢ƒè®Šæ•¸ï¼š
```bash
check-env-vars.bat
```

åªæª¢æŸ¥éŒ¯èª¤ï¼š
```bash
check-backend-error.bat
```

---

**ä¿®å¾©å®Œæˆæ™‚é–“**ï¼š2026-02-04
**æ¸¬è©¦ç‹€æ…‹**ï¼šâœ… å¾…ç”¨æˆ¶é©—è­‰
