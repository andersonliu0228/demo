# EA å¯¦æˆ°åŠŸèƒ½ - å®Œæˆç¸½çµ

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. è³‡æ–™åº«æ“´å……

#### User æ¨¡å‹æ–°å¢æ¬„ä½
- **last_seen** (DateTime): æœ€å¾Œä¸Šç·šæ™‚é–“ï¼ˆEA å¿ƒè·³ï¼‰
  - æ¯æ¬¡ EA èª¿ç”¨ `/api/v1/ea/config` æ™‚è‡ªå‹•æ›´æ–°
  - ç”¨æ–¼åˆ¤æ–·å®¢æˆ¶ç«¯æ˜¯å¦åœ¨ç·š

#### GlobalSetting æ¨¡å‹ï¼ˆæ–°å»ºï¼‰
- **key** (String): è¨­å®šéµï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰
- **value_bool** (Boolean): å¸ƒæ—å€¼
- **value_str** (String): å­—ä¸²å€¼
- **value_text** (Text): æ–‡æœ¬å€¼
- **description** (String): è¨­å®šæè¿°
- **created_at** / **updated_at**: æ™‚é–“æˆ³

é è¨­è¨­å®šï¼š
```sql
key: 'emergency_stop_all'
value_bool: false
description: 'ç·Šæ€¥å…¨åœé–‹é—œ - åœæ­¢æ‰€æœ‰è·Ÿå–®'
```

### 2. EA å°ˆç”¨ API

#### GET /api/v1/ea/config
**åŠŸèƒ½**: ä¾› MT4/MT5 EA èª¿ç”¨ï¼Œç²å–è·Ÿå–®é…ç½®

**åƒæ•¸**:
- `user_id` (query): ç”¨æˆ¶ ID

**å›å‚³**:
```json
{
  "user_id": 2,
  "username": "follower1",
  "is_active": true,
  "copy_ratio": 2.5,
  "emergency_stop": false,
  "last_seen": "2026-02-04T10:30:00",
  "message": "é…ç½®ç²å–æˆåŠŸ"
}
```

**é‡è¦ç‰¹æ€§**:
- âœ… è‡ªå‹•æ›´æ–° `last_seen` ç‚ºç•¶å‰æ™‚é–“ï¼ˆå¿ƒè·³æ©Ÿåˆ¶ï¼‰
- âœ… ç¶œåˆåˆ¤æ–·ï¼š`user.is_active` AND `relation.status == 'active'` AND `NOT emergency_stop`
- âœ… è¿”å›æœ€çµ‚çš„ `is_active` ç‹€æ…‹å’Œ `copy_ratio`

#### GET /api/v1/ea/heartbeat
**åŠŸèƒ½**: ç°¡å–®çš„å¿ƒè·³ç«¯é»ï¼Œåªæ›´æ–° last_seen

**åƒæ•¸**:
- `user_id` (query): ç”¨æˆ¶ ID

**å›å‚³**:
```json
{
  "status": "ok",
  "user_id": 2,
  "username": "follower1",
  "last_seen": "2026-02-04T10:30:00"
}
```

### 3. äº¤æ˜“å“¡ç®¡ç† API æ“´å……

#### POST /api/v1/trader/emergency-stop
**åŠŸèƒ½**: ç·Šæ€¥å…¨åœé–‹é—œ

**è«‹æ±‚**:
```json
{
  "stop_all": true
}
```

**å›å‚³**:
```json
{
  "message": "ç·Šæ€¥å…¨åœ å·²å•Ÿå‹•",
  "emergency_stop": true,
  "updated_at": "2026-02-04T10:30:00"
}
```

#### GET /api/v1/trader/emergency-stop-status
**åŠŸèƒ½**: ç²å–ç·Šæ€¥å…¨åœç‹€æ…‹

**å›å‚³**:
```json
{
  "emergency_stop": false,
  "message": "ç·Šæ€¥å…¨åœæœªå•Ÿå‹•",
  "updated_at": "2026-02-04T10:30:00"
}
```

#### GET /api/v1/trader/clientsï¼ˆå·²æ›´æ–°ï¼‰
**æ–°å¢æ¬„ä½**:
- `last_seen`: å®¢æˆ¶æœ€å¾Œä¸Šç·šæ™‚é–“

### 4. å‰ç«¯ä»‹é¢å‡ç´š

#### åœ¨ç·šç‹€æ…‹ç‡ˆè™Ÿ
åœ¨è¡¨æ ¼ç¬¬ä¸€æ¬„é¡¯ç¤ºå®¢æˆ¶åœ¨ç·šç‹€æ…‹ï¼š

**åˆ¤æ–·é‚è¼¯**:
- ğŸŸ¢ **ç¶ ç‡ˆï¼ˆåœ¨ç·šï¼‰**: last_seen < 5 åˆ†é˜
- ğŸŸ¡ **é»ƒç‡ˆï¼ˆé›¢ç·šï¼‰**: 5 åˆ†é˜ < last_seen < 30 åˆ†é˜
- ğŸ”´ **ç´…ç‡ˆï¼ˆé›¢ç·šï¼‰**: last_seen > 30 åˆ†é˜
- âšª **ç°ç‡ˆï¼ˆæœªé€£ç·šï¼‰**: last_seen ç‚º null

**è¦–è¦ºæ•ˆæœ**:
- ç¶ ç‡ˆæœƒæœ‰è„ˆè¡å‹•ç•«ï¼ˆanimate-pulseï¼‰
- é¡¯ç¤ºæ–‡å­—æ¨™ç±¤ï¼šã€Œåœ¨ç·šã€ã€ã€Œé›¢ç·šã€ã€ã€Œæœªé€£ç·šã€

#### ç·Šæ€¥å…¨åœæŒ‰éˆ•
ä½ç½®ï¼šé é¢å³ä¸Šè§’ï¼Œé‡æ–°æ•´ç†æŒ‰éˆ•æ—é‚Š

**ç‹€æ…‹**:
- æœªå•Ÿå‹•ï¼šç°è‰²æŒ‰éˆ•ã€Œç·Šæ€¥å…¨åœã€
- å·²å•Ÿå‹•ï¼šç´…è‰²æŒ‰éˆ•ã€ŒğŸš¨ ç·Šæ€¥å…¨åœä¸­ã€

**åŠŸèƒ½**:
- é»æ“Šæ™‚å½ˆå‡ºç¢ºèªå°è©±æ¡†
- å•Ÿå‹•å¾Œæ‰€æœ‰å®¢æˆ¶çš„è·Ÿå–®å°‡è¢«åœæ­¢
- è§£é™¤å¾Œæ¢å¾©æ­£å¸¸è·Ÿå–®

## ğŸ”„ å·¥ä½œæµç¨‹

### EA ç«¯æµç¨‹
```
1. EA å•Ÿå‹•
2. æ¯ 1-5 åˆ†é˜èª¿ç”¨ GET /api/v1/ea/config?user_id=X
3. å¾Œç«¯è‡ªå‹•æ›´æ–° last_seen
4. å¾Œç«¯è¿”å› is_active, copy_ratio, emergency_stop
5. EA æ ¹æ“š is_active æ±ºå®šæ˜¯å¦åŸ·è¡Œè·Ÿå–®
6. å¦‚æœ emergency_stop=trueï¼Œç«‹å³åœæ­¢æ‰€æœ‰æ“ä½œ
```

### äº¤æ˜“å“¡ç«¯æµç¨‹
```
1. æ‰“é–‹ç®¡ç†é¢æ¿ http://localhost:3000/admin
2. æŸ¥çœ‹å®¢æˆ¶åˆ—è¡¨ï¼Œè§€å¯Ÿåœ¨ç·šç‹€æ…‹ç‡ˆè™Ÿ
3. ç¶ ç‡ˆ = EA æ­£å¸¸é‹è¡Œï¼ˆ5åˆ†é˜å…§æœ‰å¿ƒè·³ï¼‰
4. ç´…ç‡ˆ/ç°ç‡ˆ = EA å¯èƒ½é›¢ç·šæˆ–æœªå•Ÿå‹•
5. ç·Šæ€¥æƒ…æ³ä¸‹é»æ“Šã€Œç·Šæ€¥å…¨åœã€æŒ‰éˆ•
6. æ‰€æœ‰ EA ä¸‹æ¬¡èª¿ç”¨ API æ™‚æœƒæ”¶åˆ° is_active=false
```

## ğŸ“Š è³‡æ–™åº«é·ç§»

### é‹è¡Œé·ç§»
```powershell
# æ–¹æ³• 1: ä½¿ç”¨è…³æœ¬
.\run-migration-010.ps1

# æ–¹æ³• 2: æ‰‹å‹•åŸ·è¡Œ
docker-compose exec backend alembic upgrade head
```

### é·ç§»å…§å®¹
- åœ¨ `users` è¡¨æ·»åŠ  `last_seen` æ¬„ä½
- å‰µå»º `global_settings` è¡¨
- æ’å…¥é è¨­çš„ `emergency_stop_all` è¨­å®š

## ğŸ§ª æ¸¬è©¦

### é‹è¡Œæ¸¬è©¦è…³æœ¬
```powershell
.\test-ea-features.ps1
```

### æ¸¬è©¦é …ç›®
1. âœ… ç™»å…¥èªè­‰
2. âœ… ç²å–å®¢æˆ¶åˆ—è¡¨ï¼ˆåŒ…å« last_seenï¼‰
3. âœ… èª¿ç”¨ EA Config API
4. âœ… é©—è­‰ last_seen è‡ªå‹•æ›´æ–°
5. âœ… ç²å–ç·Šæ€¥å…¨åœç‹€æ…‹
6. âœ… å•Ÿå‹•ç·Šæ€¥å…¨åœ
7. âœ… é©—è­‰ EA Config è¿”å› is_active=false
8. âœ… è§£é™¤ç·Šæ€¥å…¨åœ
9. âœ… æ¸¬è©¦ EA Heartbeat

### å‰ç«¯æ¸¬è©¦
1. è¨ªå• `http://localhost:3000/admin`
2. ç™»å…¥ï¼š`testuser` / `testpass123`
3. è§€å¯Ÿå®¢æˆ¶åˆ—è¡¨çš„åœ¨ç·šç‹€æ…‹ç‡ˆè™Ÿ
4. é»æ“Šã€Œç·Šæ€¥å…¨åœã€æŒ‰éˆ•æ¸¬è©¦
5. åˆ·æ–°é é¢ç¢ºèªç‹€æ…‹æŒä¹…åŒ–

## ğŸ” å®‰å…¨æ€§

- âœ… EA Config API ç„¡éœ€èªè­‰ï¼ˆä¾› EA èª¿ç”¨ï¼‰
- âœ… ç·Šæ€¥å…¨åœ API éœ€è¦ JWT èªè­‰ï¼ˆåªæœ‰äº¤æ˜“å“¡å¯æ“ä½œï¼‰
- âœ… è‡ªå‹•æ›´æ–° last_seen ä¸æœƒå½±éŸ¿å…¶ä»–æ•¸æ“š
- âœ… ç·Šæ€¥å…¨åœç‹€æ…‹å…¨å±€ç”Ÿæ•ˆï¼Œå½±éŸ¿æ‰€æœ‰å®¢æˆ¶

## ğŸ“ API ä½¿ç”¨ç¯„ä¾‹

### EA èª¿ç”¨é…ç½® API
```python
# MT4/MT5 EA å½ä»£ç¢¼
def OnTimer():
    user_id = 2  # å¾é…ç½®è®€å–
    url = f"http://your-server:8000/api/v1/ea/config?user_id={user_id}"
    
    response = http_get(url)
    config = json_parse(response)
    
    if config["is_active"] and not config["emergency_stop"]:
        # åŸ·è¡Œè·Ÿå–®é‚è¼¯
        copy_ratio = config["copy_ratio"]
        execute_copy_trade(copy_ratio)
    else:
        # åœæ­¢è·Ÿå–®
        print("è·Ÿå–®å·²åœç”¨æˆ–ç·Šæ€¥å…¨åœä¸­")
```

### äº¤æ˜“å“¡å•Ÿå‹•ç·Šæ€¥å…¨åœ
```bash
curl -X POST http://localhost:8000/api/v1/trader/emergency-stop \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"stop_all": true}'
```

### æŸ¥è©¢ç·Šæ€¥å…¨åœç‹€æ…‹
```bash
curl -X GET http://localhost:8000/api/v1/trader/emergency-stop-status \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## ğŸ¯ å¯¦æˆ°å ´æ™¯

### å ´æ™¯ 1: æ­£å¸¸é‹è¡Œ
- EA æ¯ 2 åˆ†é˜èª¿ç”¨ `/api/v1/ea/config`
- å‰ç«¯é¡¯ç¤ºç¶ ç‡ˆï¼ˆåœ¨ç·šï¼‰
- äº¤æ˜“å“¡å¯ä»¥çœ‹åˆ°æ‰€æœ‰å®¢æˆ¶çš„å¯¦æ™‚ç‹€æ…‹

### å ´æ™¯ 2: EA é›¢ç·š
- EA åœæ­¢é‹è¡Œæˆ–ç¶²çµ¡ä¸­æ–·
- 5 åˆ†é˜å¾Œå‰ç«¯é¡¯ç¤ºé»ƒç‡ˆ
- 30 åˆ†é˜å¾Œå‰ç«¯é¡¯ç¤ºç´…ç‡ˆ
- äº¤æ˜“å“¡å¯ä»¥è¯ç¹«å®¢æˆ¶æª¢æŸ¥ EA ç‹€æ…‹

### å ´æ™¯ 3: ç·Šæ€¥å…¨åœ
- å¸‚å ´ç•°å¸¸æ³¢å‹•ï¼Œäº¤æ˜“å“¡é»æ“Šã€Œç·Šæ€¥å…¨åœã€
- æ‰€æœ‰ EA ä¸‹æ¬¡èª¿ç”¨ API æ™‚æ”¶åˆ° `is_active=false`
- EA ç«‹å³åœæ­¢æ‰€æœ‰è·Ÿå–®æ“ä½œ
- äº¤æ˜“å“¡ç¢ºèªå®‰å…¨å¾Œè§£é™¤ç·Šæ€¥å…¨åœ

### å ´æ™¯ 4: å–®å€‹å®¢æˆ¶åœç”¨
- äº¤æ˜“å“¡åœ¨ç®¡ç†é¢æ¿é»æ“Šã€Œå°é–ã€æŒ‰éˆ•
- è©²å®¢æˆ¶çš„ `relation.status` è®Šç‚º `blocked`
- EA èª¿ç”¨ API æ™‚æ”¶åˆ° `is_active=false`
- åªå½±éŸ¿è©²å®¢æˆ¶ï¼Œå…¶ä»–å®¢æˆ¶æ­£å¸¸é‹è¡Œ

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### 1. é‹è¡Œè³‡æ–™åº«é·ç§»
```powershell
.\run-migration-010.ps1
```

### 2. é‡å•Ÿå¾Œç«¯
```powershell
docker-compose restart backend
```

### 3. é‡å•Ÿå‰ç«¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
```powershell
docker-compose restart frontend
```

### 4. é©—è­‰åŠŸèƒ½
```powershell
.\test-ea-features.ps1
```

### 5. é…ç½® EA
åœ¨ MT4/MT5 EA ä¸­é…ç½®ï¼š
- API URL: `http://your-server:8000/api/v1/ea/config`
- User ID: å¾ç®¡ç†é¢æ¿ç²å–
- å¿ƒè·³é–“éš”: 1-5 åˆ†é˜

## ğŸ“ æ”¯æ´

å¦‚æœ‰å•é¡Œï¼Œè«‹æŸ¥çœ‹ï¼š
- `QUICK_REFERENCE.md` - å¿«é€Ÿåƒè€ƒæŒ‡å—
- `SWAGGER_æ¸¬è©¦æŒ‡å—.md` - API æ–‡æª”
- `å®Œæ•´ç³»çµ±å¿«é€Ÿå•Ÿå‹•æŒ‡å—.md` - ç³»çµ±å•Ÿå‹•æŒ‡å—

---

**ç‹€æ…‹**: âœ… å®Œæˆä¸¦æ¸¬è©¦é€šé
**æ—¥æœŸ**: 2026-02-04
**ç‰ˆæœ¬**: 2.0.0 - EA å¯¦æˆ°åŠŸèƒ½è£œå®Œ
