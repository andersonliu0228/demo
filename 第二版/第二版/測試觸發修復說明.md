# 測試觸發 Master 訂單修復說明

## 問題描述

在使用 `POST /api/v1/test/trigger-master-order` 端點時，如果指定的 `master_credential_id` 在 `api_credentials` 表中不存在，會觸發 `ForeignKeyViolationError`，因為 `master_positions` 表的 `master_credential_id` 欄位引用了 `api_credentials` 表的主鍵。

### 錯誤訊息範例
```
ForeignKeyViolationError: insert or update on table "master_positions" violates foreign key constraint
```

## 解決方案

修改 `backend/app/routes/test_routes.py` 中的 `trigger_master_order` 函數，在創建/更新 Master 倉位之前，自動檢查並創建必要的測試憑證。

### 修改內容

1. **添加憑證檢查邏輯**
   - 在創建 Master 倉位之前，先查詢 `api_credentials` 表
   - 檢查指定的 `master_credential_id` 是否存在

2. **自動創建測試憑證**
   - 如果憑證不存在，使用 `CredentialService` 自動創建一個測試憑證
   - 憑證配置：
     - `exchange_name`: "mock"
     - `api_key`: `test_master_key_{user_id}_{credential_id}`
     - `api_secret`: `test_master_secret_{user_id}_{credential_id}`
     - `verify`: False（跳過驗證，因為是測試憑證）

3. **添加依賴注入**
   - 在函數參數中添加 `credential_service: CredentialService = Depends(get_credential_service)`
   - 使用 Service 層確保正確的加密和資料庫操作

4. **返回資訊增強**
   - 在回應中添加 `credential_info` 欄位
   - 包含 `auto_created` 標記，指示憑證是否為自動創建

## 使用方式

### 1. 啟動 Docker 系統
```powershell
.\docker-start.ps1
```

### 2. 執行測試腳本
```powershell
.\test-trigger-master-order.ps1
```

### 3. 手動測試

#### 測試 1: 使用不存在的憑證 ID
```bash
curl -X POST "http://localhost:8000/api/v1/test/trigger-master-order" \
  -H "Content-Type: application/json" \
  -d '{
    "master_user_id": 1,
    "master_credential_id": 999,
    "symbol": "BTC/USDT",
    "position_size": 1.5,
    "entry_price": 50000.0
  }'
```

**預期結果**：
- ✅ 請求成功
- ✅ 自動創建測試憑證
- ✅ 創建 Master 倉位
- 回應中 `credential_info.auto_created` 為 `true`

#### 測試 2: 再次使用相同的憑證 ID
```bash
curl -X POST "http://localhost:8000/api/v1/test/trigger-master-order" \
  -H "Content-Type: application/json" \
  -d '{
    "master_user_id": 1,
    "master_credential_id": 999,
    "symbol": "ETH/USDT",
    "position_size": 2.0,
    "entry_price": 3000.0
  }'
```

**預期結果**：
- ✅ 請求成功
- ✅ 使用現有憑證（不重複創建）
- ✅ 創建新的 Master 倉位
- 回應中 `credential_info.auto_created` 為 `false`

## 回應格式

```json
{
  "success": true,
  "message": "Master 訂單已觸發，儀表板數據將在 3 秒內更新",
  "credential_info": {
    "credential_id": 999,
    "auto_created": true,
    "note": "測試憑證已自動創建"
  },
  "master_info": {
    "user_id": 1,
    "credential_id": 999,
    "symbol": "BTC/USDT",
    "old_position_size": 0,
    "new_position_size": 1.5,
    "entry_price": 50000.0,
    "position_changed": true,
    "last_updated": "2024-01-01T12:00:00"
  },
  "followers_count": 0,
  "followers_breakdown": {
    "v1_followers": 0,
    "v2_followers": 0
  },
  "expected_trades": [],
  "dashboard_update": {
    "note": "儀表板 API (GET /api/v1/dashboard/summary) 將立即反映 Master 倉位變動",
    "follower_positions_update": "跟單引擎將在下一個輪詢週期（最多 3 秒）執行對帳並更新跟隨者倉位",
    "polling_interval": "3 秒"
  }
}
```

## 技術細節

### 加密流程
自動創建的測試憑證會經過完整的加密流程：
1. `api_secret` 使用 `CryptoService.encrypt()` 加密
2. 加密後的密文存儲在 `api_credentials.encrypted_api_secret` 欄位
3. 使用時通過 `CryptoService.decrypt()` 解密

### 資料庫約束
- `api_credentials` 表有唯一性約束：`(user_id, exchange_name, api_key)`
- 自動生成的 `api_key` 包含 `user_id` 和 `credential_id`，確保唯一性
- `master_positions.master_credential_id` 外鍵引用 `api_credentials.id`

### 日誌記錄
修復後的端點會記錄以下資訊：
- ⚠️ 憑證不存在時的警告
- ✅ 自動創建憑證成功
- ❌ 自動創建憑證失敗
- ✨ Master 訂單觸發成功

## 優點

1. **自動化測試**：無需手動創建測試憑證
2. **錯誤預防**：避免 ForeignKeyViolationError
3. **開發友好**：簡化測試流程
4. **資料一致性**：使用 Service 層確保正確的加密和驗證
5. **可追溯性**：清晰的日誌和回應資訊

## 注意事項

1. 此功能僅用於測試環境
2. 自動創建的憑證使用 Mock Exchange
3. 如果自動創建的憑證 ID 與請求的不同，會使用實際創建的 ID
4. 憑證創建失敗時會返回 500 錯誤並包含詳細錯誤訊息

## 相關文件

- `backend/app/routes/test_routes.py` - 測試路由（已修改）
- `backend/app/services/credential_service.py` - 憑證服務
- `backend/app/models/api_credential.py` - 憑證模型
- `test-trigger-master-order.ps1` - 測試腳本
