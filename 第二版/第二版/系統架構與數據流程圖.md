# 系統架構與數據流程圖

## 整體架構

```
┌─────────────────────────────────────────────────────────────┐
│                         用戶瀏覽器                            │
│                    http://localhost:3000                     │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ HTTP/REST API
                         │
┌────────────────────────▼────────────────────────────────────┐
│                      前端 (React)                            │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Dashboard.jsx (每3秒輪詢)                           │  │
│  │  - 實時數據顯示                                       │  │
│  │  - 一鍵開關                                          │  │
│  │  - Toast 通知                                        │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  API Client (Axios)                                  │  │
│  │  - dashboardApi.getSummary()                         │  │
│  │  - followConfigApi.updateSettings()                  │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ HTTP/REST API
                         │
┌────────────────────────▼────────────────────────────────────┐
│                    後端 (FastAPI)                            │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Dashboard Routes                                    │  │
│  │  GET /api/v1/dashboard/summary                       │  │
│  │  - 聚合所有數據                                       │  │
│  │  - 返回 JSON 響應                                    │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Follow Config Routes                                │  │
│  │  PUT /api/v1/follow-config/settings                  │  │
│  │  - 更新跟單設定                                       │  │
│  │  - 觸發 Worker 同步                                  │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Follower Engine V2 (Background Worker)             │  │
│  │  - 每 3 秒輪詢                                        │  │
│  │  - 檢測 is_active 狀態                               │  │
│  │  - 執行對帳同步                                       │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ SQL Queries
                         │
┌────────────────────────▼────────────────────────────────────┐
│                   PostgreSQL 資料庫                          │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  users (用戶表)                                       │  │
│  │  api_credentials (API 憑證表)                        │  │
│  │  follow_settings (跟單設定表)                        │  │
│  │  master_positions (Master 倉位表)                    │  │
│  │  follower_positions (Follower 倉位表)               │  │
│  │  trade_logs (交易日誌表)                             │  │
│  │  trade_errors (交易錯誤表)                           │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 實時監控數據流

```
┌─────────────┐
│   前端      │
│  Dashboard  │
└──────┬──────┘
       │
       │ 每 3 秒輪詢
       │
       ▼
┌─────────────────────────────────────────┐
│  GET /api/v1/dashboard/summary          │
└──────┬──────────────────────────────────┘
       │
       │ 查詢資料庫
       │
       ▼
┌─────────────────────────────────────────┐
│  聚合數據                                │
│  ┌─────────────────────────────────┐   │
│  │ 1. 查詢 follow_settings         │   │
│  │    - is_active                  │   │
│  │    - follow_ratio               │   │
│  │    - master_user_id             │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 2. 查詢 follower_positions      │   │
│  │    - 計算總持倉價值              │   │
│  │    - 我的倉位列表                │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 3. 查詢 master_positions        │   │
│  │    - Master 倉位列表            │   │
│  │    - 最新動作                    │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 4. 查詢 trade_logs              │   │
│  │    - 最近 5 筆成功交易          │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 5. 查詢 trade_errors            │   │
│  │    - 未解決錯誤數量              │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 6. 檢查 Worker 狀態             │   │
│  │    - is_running                 │   │
│  │    - poll_interval              │   │
│  └─────────────────────────────────┘   │
└──────┬──────────────────────────────────┘
       │
       │ 返回 JSON
       │
       ▼
┌─────────────────────────────────────────┐
│  前端渲染                                │
│  - 更新統計卡片                          │
│  - 更新倉位列表                          │
│  - 更新交易歷史                          │
│  - 顯示錯誤通知（如有）                  │
└─────────────────────────────────────────┘
```

## 一鍵開關流程

```
┌─────────────┐
│   用戶      │
│  點擊開關   │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────┐
│  前端 handleToggleActive()              │
│  - 切換 is_active 狀態                  │
│  - 顯示 Loading 動畫                    │
└──────┬──────────────────────────────────┘
       │
       │ PUT /api/v1/follow-config/settings
       │
       ▼
┌─────────────────────────────────────────┐
│  後端更新 follow_settings               │
│  UPDATE follow_settings                 │
│  SET is_active = true/false             │
│  WHERE user_id = ?                      │
└──────┬──────────────────────────────────┘
       │
       │ 返回成功
       │
       ▼
┌─────────────────────────────────────────┐
│  前端顯示 Toast 通知                    │
│  - 成功：綠色通知                        │
│  - 失敗：紅色通知                        │
│  - 自動刷新數據                          │
└──────┬──────────────────────────────────┘
       │
       │ 等待 Worker 檢測（最多 3 秒）
       │
       ▼
┌─────────────────────────────────────────┐
│  Follower Engine V2 Worker             │
│  - 每 3 秒輪詢一次                      │
│  - 檢測 is_active 變更                  │
└──────┬──────────────────────────────────┘
       │
       ├─────────────┬─────────────┐
       │             │             │
       ▼             ▼             ▼
  is_active=true  is_active=false  無變更
       │             │             │
       ▼             ▼             ▼
  執行對帳同步    停止處理該用戶   繼續輪詢
       │             │             │
       ▼             ▼             ▼
  更新 follower   不執行任何操作   等待下次
  _positions                       輪詢
```

## 錯誤通知流程

```
┌─────────────────────────────────────────┐
│  Follower Engine 執行交易               │
└──────┬──────────────────────────────────┘
       │
       ├─────────────┬─────────────┐
       │             │             │
       ▼             ▼             ▼
    成功          失敗          異常
       │             │             │
       ▼             ▼             ▼
  寫入 trade_logs  寫入 trade_errors  寫入 trade_errors
  is_success=true  error_type=...    error_type=...
       │             │             │
       │             └─────┬───────┘
       │                   │
       │                   ▼
       │          ┌─────────────────────┐
       │          │  trade_errors 表    │
       │          │  - user_id          │
       │          │  - error_message    │
       │          │  - is_resolved=false│
       │          └──────┬──────────────┘
       │                 │
       │                 │
       ▼                 ▼
┌─────────────────────────────────────────┐
│  前端輪詢檢測                            │
│  GET /api/v1/dashboard/summary          │
│  - has_unresolved_errors                │
│  - unresolved_error_count               │
└──────┬──────────────────────────────────┘
       │
       │ 檢測到錯誤
       │
       ▼
┌─────────────────────────────────────────┐
│  useEffect 觸發                         │
│  if (has_unresolved_errors) {           │
│    showToast("⚠️ 檢測到錯誤", "error")  │
│  }                                      │
└──────┬──────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────┐
│  顯示 Toast 通知                        │
│  ┌───────────────────────────────────┐ │
│  │  ⚠️ 檢測到 2 個未解決的交易錯誤！  │ │
│  │                              [✕]  │ │
│  └───────────────────────────────────┘ │
│  - 紅色邊框 + 紅色背景                  │
│  - 5 秒後自動消失                       │
│  - 可手動關閉                           │
└─────────────────────────────────────────┘
```

## Master 訂單觸發與同步流程

```
┌─────────────┐
│  測試腳本   │
│  或 Swagger │
└──────┬──────┘
       │
       │ POST /api/v1/test/trigger-master-order
       │
       ▼
┌─────────────────────────────────────────┐
│  1. 檢查憑證是否存在                     │
│     SELECT * FROM api_credentials       │
│     WHERE id = master_credential_id     │
└──────┬──────────────────────────────────┘
       │
       ├─────────────┬─────────────┐
       │             │             │
       ▼             ▼             ▼
    存在          不存在        錯誤
       │             │             │
       │             ▼             ▼
       │      自動創建憑證      返回錯誤
       │      (Mock Exchange)
       │             │
       └─────┬───────┘
             │
             ▼
┌─────────────────────────────────────────┐
│  2. 更新或創建 Master 倉位               │
│     INSERT/UPDATE master_positions      │
│     SET position_size = ?               │
│         entry_price = ?                 │
│         last_updated = NOW()            │
└──────┬──────────────────────────────────┘
       │
       │ 立即返回成功
       │
       ▼
┌─────────────────────────────────────────┐
│  前端儀表板立即顯示 Master 倉位變動      │
└──────┬──────────────────────────────────┘
       │
       │ 等待 Worker 輪詢（最多 3 秒）
       │
       ▼
┌─────────────────────────────────────────┐
│  Follower Engine V2 檢測變動            │
│  - 比對 master_positions                │
│  - 比對 follower_positions              │
│  - 計算差異                              │
└──────┬──────────────────────────────────┘
       │
       │ 發現差異
       │
       ▼
┌─────────────────────────────────────────┐
│  執行對帳同步                            │
│  1. 計算目標倉位                         │
│     target = master_size × follow_ratio │
│  2. 計算需要調整的數量                   │
│     delta = target - current            │
│  3. 執行交易                             │
│     - 調用 MockExchange                 │
│     - 記錄 trade_logs                   │
│  4. 更新 follower_positions             │
└──────┬──────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────┐
│  前端下次輪詢時顯示 Follower 倉位更新    │
│  - Master: 1.5 BTC                      │
│  - Follower: 0.75 BTC (50% 跟單比例)   │
└─────────────────────────────────────────┘
```

## 數據初始化流程

```
┌─────────────┐
│  執行腳本   │
│  init-test- │
│  data.ps1   │
└──────┬──────┘
       │
       │ docker compose exec backend
       │ python scripts/init_test_data.py
       │
       ▼
┌─────────────────────────────────────────┐
│  1. 檢查 testuser 是否存在              │
│     SELECT * FROM users                 │
│     WHERE username = 'testuser'         │
└──────┬──────────────────────────────────┘
       │
       ├─────────────┬─────────────┐
       │             │             │
       ▼             ▼             ▼
    存在          不存在        錯誤
       │             │             │
       │             ▼             ▼
       │      創建 testuser     返回錯誤
       │      - username: testuser
       │      - password: testpass123
       │      - email: test@example.com
       │             │
       └─────┬───────┘
             │
             ▼
┌─────────────────────────────────────────┐
│  2. 檢查 ID=1 的憑證是否存在            │
│     SELECT * FROM api_credentials       │
│     WHERE id = 1                        │
└──────┬──────────────────────────────────┘
       │
       ├─────────────┬─────────────┐
       │             │             │
       ▼             ▼             ▼
    存在          不存在        錯誤
       │             │             │
       │             ▼             ▼
       │      創建憑證 ID=1     返回錯誤
       │      - user_id: testuser.id
       │      - exchange: mock
       │      - api_key: test_api_key_12345
       │      - encrypted_secret: (加密)
       │             │
       └─────┬───────┘
             │
             ▼
┌─────────────────────────────────────────┐
│  初始化完成                              │
│  ✅ testuser 已就緒                     │
│  ✅ ID=1 憑證已就緒                     │
│  ✅ 系統可以開始測試                     │
└─────────────────────────────────────────┘
```

## 系統啟動順序

```
1. docker-start.ps1
   ↓
2. Docker Compose 啟動所有容器
   ├─ PostgreSQL (資料庫)
   ├─ Redis (快取)
   ├─ Backend (FastAPI + Worker)
   └─ Frontend (React + Nginx)
   ↓
3. 等待服務啟動（30秒）
   ↓
4. init-test-data.ps1
   ├─ 創建 testuser
   └─ 創建 ID=1 憑證
   ↓
5. 系統就緒
   ├─ 前端: http://localhost:3000
   ├─ 後端: http://localhost:8000
   └─ Swagger: http://localhost:8000/docs
```

## 關鍵時間點

```
事件                          時間
─────────────────────────────────────
前端輪詢間隔                   3 秒
Worker 輪詢間隔                3 秒
Toast 通知顯示時間             5 秒
Docker 啟動等待時間            30 秒
API 響應時間                   < 100ms
前端渲染時間                   < 50ms
```

## 數據一致性保證

```
Master 倉位變動
    ↓
立即寫入 master_positions 表
    ↓
Worker 在 3 秒內檢測到變動
    ↓
執行對帳計算
    ↓
target_position = master_position × follow_ratio
    ↓
執行交易調整 follower_positions
    ↓
前端在下次輪詢時顯示更新（最多 3 秒）
    ↓
數據一致性達成
```

---

**說明**: 本圖展示了完整系統的架構和各個數據流程，幫助理解系統運作原理。
