# èªè­‰æµç¨‹å®Œæ•´ä¿®å¾©

## ğŸ¯ ä¿®å¾©ç›®æ¨™
å¾¹åº•ä¿®å¾©ç™»å…¥èˆ‡èªè­‰æµç¨‹ï¼Œç¢ºä¿å‰å¾Œç«¯å®Œç¾å°æ¥

---

## ğŸ” å•é¡Œè¨ºæ–·

### å¾Œç«¯ API åˆ†æ
- **ç«¯é»**ï¼š`POST /api/v1/auth/login`
- **è«‹æ±‚æ ¼å¼**ï¼š`application/x-www-form-urlencoded`
- **è«‹æ±‚åƒæ•¸**ï¼š
  - `username`ï¼šç”¨æˆ¶åï¼ˆä¸æ˜¯ emailï¼‰
  - `password`ï¼šå¯†ç¢¼
- **éŸ¿æ‡‰æ ¼å¼**ï¼š
  ```json
  {
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "token_type": "bearer"
  }
  ```
- **æ³¨æ„**ï¼šéŸ¿æ‡‰ä¸­**æ²’æœ‰** `user_id` æˆ– `username` æ¬„ä½

### å‰ç«¯å•é¡Œ
1. âŒ å˜—è©¦å¾éŸ¿æ‡‰ä¸­è®€å–ä¸å­˜åœ¨çš„ `user_id` å’Œ `username`
2. âŒ æ²’æœ‰æ¸…é™¤èˆŠçš„ localStorage æ•¸æ“š
3. âŒ ç¼ºå°‘è©³ç´°çš„èª¿è©¦æ—¥èªŒ
4. âŒ è·³è½‰æ™‚æ²’æœ‰ä½¿ç”¨ `replace: true`

---

## âœ… ä¿®å¾©å…§å®¹

### 1. Login.jsx å®Œæ•´ä¿®å¾©

#### ä¿®å¾©å‰
```javascript
const handleSubmit = async (e) => {
  e.preventDefault();
  setLoading(true);
  setError('');

  try {
    const response = await authApi.login(username, password);
    
    // âŒ éŒ¯èª¤ï¼šéŸ¿æ‡‰ä¸­æ²’æœ‰é€™äº›æ¬„ä½
    localStorage.setItem('token', response.data.access_token);
    localStorage.setItem('user', JSON.stringify({
      id: response.data.user_id,  // âŒ ä¸å­˜åœ¨
      username: response.data.username  // âŒ ä¸å­˜åœ¨
    }));
    
    navigate('/dashboard');  // âŒ æ²’æœ‰ replace
  } catch (err) {
    setError(err.response?.data?.detail || 'ç™»å…¥å¤±æ•—');
  } finally {
    setLoading(false);
  }
};
```

#### ä¿®å¾©å¾Œ
```javascript
const handleSubmit = async (e) => {
  e.preventDefault();
  setLoading(true);
  setError('');

  // âœ… æ¸…é™¤èˆŠæ•¸æ“š
  localStorage.clear();
  console.log('ğŸ§¹ å·²æ¸…é™¤èˆŠçš„ localStorage æ•¸æ“š');

  try {
    console.log('ğŸ” å˜—è©¦ç™»å…¥:', { username, api: 'http://localhost:8000/api/v1/auth/login' });
    
    const response = await authApi.login(username, password);
    
    console.log('âœ… ç™»å…¥æˆåŠŸï¼ŒéŸ¿æ‡‰:', response.data);
    
    // âœ… æ­£ç¢ºè™•ç†éŸ¿æ‡‰
    const token = response.data.access_token;
    const userInfo = {
      username: username, // ä½¿ç”¨ç™»å…¥æ™‚çš„ç”¨æˆ¶å
    };
    
    localStorage.setItem('token', token);
    localStorage.setItem('user', JSON.stringify(userInfo));
    
    console.log('ğŸ’¾ å·²å„²å­˜ Token å’Œç”¨æˆ¶è³‡è¨Š');
    console.log('Token:', token.substring(0, 20) + '...');
    console.log('User:', userInfo);
    
    // âœ… ä½¿ç”¨ replace è·³è½‰
    console.log('ğŸš€ è·³è½‰åˆ° Dashboard');
    navigate('/dashboard', { replace: true });
  } catch (err) {
    console.error('âŒ ç™»å…¥å¤±æ•—:', err);
    console.error('éŒ¯èª¤è©³æƒ…:', err.response?.data);
    setError(err.response?.data?.detail || 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç”¨æˆ¶åå’Œå¯†ç¢¼');
  } finally {
    setLoading(false);
  }
};
```

### 2. API é…ç½®ç¢ºèª

#### api.js
```javascript
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000';

export const authApi = {
  login: (username, password) => 
    apiClient.post('/api/v1/auth/login', 
      new URLSearchParams({ username, password }),
      { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } }
    ),
};
```

**ç¢ºèªé»**ï¼š
- âœ… ä½¿ç”¨ `http://localhost:8000`ï¼ˆä¸æ˜¯å®¹å™¨å…§éƒ¨åœ°å€ï¼‰
- âœ… ä½¿ç”¨ `URLSearchParams` æ ¼å¼åŒ–è«‹æ±‚é«”
- âœ… è¨­ç½®æ­£ç¢ºçš„ Content-Type

### 3. App.jsx ç”¨æˆ¶ç‹€æ…‹ç®¡ç†

```javascript
useEffect(() => {
  const loadUser = () => {
    try {
      const token = localStorage.getItem('token');
      const userStr = localStorage.getItem('user');
      
      if (token && userStr) {
        const userData = JSON.parse(userStr);
        setUser(userData);
        console.log('âœ… ç”¨æˆ¶å·²ç™»å…¥:', userData.username);
      } else {
        setUser(null);
        console.log('â„¹ï¸ ç”¨æˆ¶æœªç™»å…¥');
      }
    } catch (error) {
      console.error('âŒ è§£æç”¨æˆ¶è³‡è¨Šå¤±æ•—:', error);
      setUser(null);
    }
  };
  
  loadUser();
  
  // ç›£è½ storage äº‹ä»¶ï¼ˆè·¨æ¨™ç±¤é åŒæ­¥ï¼‰
  window.addEventListener('storage', loadUser);
  
  return () => {
    window.removeEventListener('storage', loadUser);
  };
}, [location.pathname]);
```

---

## ğŸ§ª æ¸¬è©¦æµç¨‹

### 1. æ¸¬è©¦å¾Œç«¯ API
```bash
curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=testuser&password=testpass123"
```

**é æœŸéŸ¿æ‡‰**ï¼š
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "token_type": "bearer"
}
```

### 2. æ¸¬è©¦å‰ç«¯ç™»å…¥æµç¨‹

#### æ­¥é©Ÿ 1ï¼šæ‰“é–‹ç€è¦½å™¨
è¨ªå• `http://localhost:3000`

#### æ­¥é©Ÿ 2ï¼šæ‰“é–‹é–‹ç™¼è€…å·¥å…·
æŒ‰ `F12`ï¼Œåˆ‡æ›åˆ° Console æ¨™ç±¤

#### æ­¥é©Ÿ 3ï¼šè¼¸å…¥ç™»å…¥è³‡è¨Š
- ç”¨æˆ¶åï¼š`testuser`
- å¯†ç¢¼ï¼š`testpass123`

#### æ­¥é©Ÿ 4ï¼šé»æ“Šç™»å…¥

#### æ­¥é©Ÿ 5ï¼šæŸ¥çœ‹ Console æ—¥èªŒ
æ‡‰è©²çœ‹åˆ°ä»¥ä¸‹æ—¥èªŒï¼ˆæŒ‰é †åºï¼‰ï¼š
```
ğŸ§¹ å·²æ¸…é™¤èˆŠçš„ localStorage æ•¸æ“š
ğŸ” å˜—è©¦ç™»å…¥: {username: "testuser", api: "http://localhost:8000/api/v1/auth/login"}
âœ… ç™»å…¥æˆåŠŸï¼ŒéŸ¿æ‡‰: {access_token: "eyJ...", token_type: "bearer"}
ğŸ’¾ å·²å„²å­˜ Token å’Œç”¨æˆ¶è³‡è¨Š
Token: eyJ0eXAiOiJKV1QiLCJh...
User: {username: "testuser"}
ğŸš€ è·³è½‰åˆ° Dashboard
âœ… ç”¨æˆ¶å·²ç™»å…¥: testuser
```

#### æ­¥é©Ÿ 6ï¼šæª¢æŸ¥ Local Storage
åˆ‡æ›åˆ° Application æ¨™ç±¤ â†’ Local Storage â†’ `http://localhost:3000`

æ‡‰è©²çœ‹åˆ°ï¼š
- `token`: `eyJ0eXAiOiJKV1QiLCJhbGc...`
- `user`: `{"username":"testuser"}`

#### æ­¥é©Ÿ 7ï¼šæª¢æŸ¥é é¢
- æ‡‰è©²è·³è½‰åˆ° `/dashboard`
- é ‚éƒ¨æ‡‰è©²é¡¯ç¤º Navbar
- Navbar æ‡‰è©²é¡¯ç¤ºç”¨æˆ¶å "testuser"
- å³ä¸Šè§’æ‡‰è©²æœ‰ç™»å‡ºæŒ‰éˆ•

### 3. æ¸¬è©¦ç™»å‡ºæµç¨‹

#### æ­¥é©Ÿ 1ï¼šé»æ“Šç™»å‡ºæŒ‰éˆ•

#### æ­¥é©Ÿ 2ï¼šæŸ¥çœ‹ Console æ—¥èªŒ
```
âœ… å·²ç™»å‡ºï¼Œæ¸…é™¤ Token å’Œç”¨æˆ¶è³‡è¨Š
â„¹ï¸ ç”¨æˆ¶æœªç™»å…¥
```

#### æ­¥é©Ÿ 3ï¼šæª¢æŸ¥ Local Storage
- `token` å’Œ `user` æ‡‰è©²è¢«æ¸…é™¤

#### æ­¥é©Ÿ 4ï¼šæª¢æŸ¥é é¢
- æ‡‰è©²è·³è½‰åˆ° `/login`
- Navbar æ‡‰è©²æ¶ˆå¤±

#### æ­¥é©Ÿ 5ï¼šæ¸¬è©¦è¿”å›éµ
é»æ“Šç€è¦½å™¨çš„è¿”å›éµ
- **é æœŸ**ï¼šç„¡æ³•è¿”å›åˆ° Dashboardï¼ˆå› ç‚ºä½¿ç”¨äº† `replace: true`ï¼‰

---

## ğŸ” å•é¡Œæ’æŸ¥

### å•é¡Œ 1ï¼šç™»å…¥å¾Œä»ç„¶ç™½å±

**å¯èƒ½åŸå› **ï¼š
1. Dashboard çµ„ä»¶æœ‰éŒ¯èª¤
2. API è«‹æ±‚å¤±æ•—
3. Token æœªæ­£ç¢ºå„²å­˜

**æ’æŸ¥æ­¥é©Ÿ**ï¼š
1. æŸ¥çœ‹ Console æ˜¯å¦æœ‰éŒ¯èª¤
2. æŸ¥çœ‹ Network æ¨™ç±¤ï¼Œæª¢æŸ¥ `/api/v1/auth/login` è«‹æ±‚
3. æŸ¥çœ‹ Local Storage æ˜¯å¦æœ‰ token å’Œ user
4. æŸ¥çœ‹å¾Œç«¯æ—¥èªŒï¼š`docker logs ea_trading_backend`

### å•é¡Œ 2ï¼šç™»å…¥è«‹æ±‚å¤±æ•—ï¼ˆ401ï¼‰

**å¯èƒ½åŸå› **ï¼š
1. ç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤
2. ç”¨æˆ¶ä¸å­˜åœ¨
3. å¾Œç«¯æœå‹™æœªé‹è¡Œ

**æ’æŸ¥æ­¥é©Ÿ**ï¼š
1. ç¢ºèªæ¸¬è©¦ç”¨æˆ¶å­˜åœ¨ï¼š
   ```bash
   docker exec -it ea_trading_backend python -c "
   from backend.app.database import SessionLocal
   from backend.app.models.user import User
   db = SessionLocal()
   user = db.query(User).filter(User.username == 'testuser').first()
   print(f'User exists: {user is not None}')
   if user:
       print(f'Username: {user.username}')
       print(f'Email: {user.email}')
       print(f'Active: {user.is_active}')
   db.close()
   "
   ```

2. å¦‚æœç”¨æˆ¶ä¸å­˜åœ¨ï¼Œå‰µå»ºæ¸¬è©¦ç”¨æˆ¶ï¼š
   ```bash
   docker exec -it ea_trading_backend python scripts/init_test_data.py
   ```

3. æª¢æŸ¥å¾Œç«¯æœå‹™ï¼š
   ```bash
   docker ps | grep backend
   curl http://localhost:8000/health
   ```

### å•é¡Œ 3ï¼šToken éæœŸ

**ç—‡ç‹€**ï¼š
- ç™»å…¥æˆåŠŸä½†ç«‹å³è¢«ç™»å‡º
- API è«‹æ±‚è¿”å› 401

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥ç³»çµ±æ™‚é–“æ˜¯å¦æ­£ç¢º
2. æª¢æŸ¥ JWT é…ç½®ï¼š
   ```python
   # backend/app/config.py
   ACCESS_TOKEN_EXPIRE_MINUTES = 1440  # 24 å°æ™‚
   ```

### å•é¡Œ 4ï¼šCORS éŒ¯èª¤

**ç—‡ç‹€**ï¼š
- Console é¡¯ç¤º CORS éŒ¯èª¤
- Network æ¨™ç±¤é¡¯ç¤ºè«‹æ±‚è¢«é˜»æ­¢

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
æª¢æŸ¥å¾Œç«¯ CORS é…ç½®ï¼š
```python
# backend/app/main.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

## ğŸ“Š å®Œæ•´æµç¨‹åœ–

```
ç”¨æˆ¶è¨ªå• /
    â†“
é‡å®šå‘åˆ° /login
    â†“
è¼¸å…¥ç”¨æˆ¶åå’Œå¯†ç¢¼
    â†“
é»æ“Šç™»å…¥
    â†“
æ¸…é™¤ localStorage â† ğŸ†•
    â†“
ç™¼é€ POST /api/v1/auth/login
    â†“
å¾Œç«¯é©—è­‰ç”¨æˆ¶åå’Œå¯†ç¢¼
    â†“
ç”Ÿæˆ JWT Token
    â†“
è¿”å› {access_token, token_type}
    â†“
å‰ç«¯å„²å­˜ token å’Œ user â† ğŸ†• åªå„²å­˜ username
    â†“
è·³è½‰åˆ° /dashboard (replace: true) â† ğŸ†•
    â†“
ProtectedRoute æª¢æŸ¥ token
    â†“
è¼‰å…¥ Dashboard çµ„ä»¶
    â†“
é¡¯ç¤º Navbarï¼ˆå«ç”¨æˆ¶åï¼‰
    â†“
ç”¨æˆ¶é»æ“Šç™»å‡º
    â†“
æ¸…é™¤ localStorage
    â†“
è·³è½‰åˆ° /login (replace: true)
```

---

## âœ… é©—è­‰æ¸…å–®

å®Œæˆä»¥ä¸‹æ‰€æœ‰é …ç›®ï¼Œç¢ºèªèªè­‰æµç¨‹æ­£å¸¸ï¼š

- [ ] å¾Œç«¯ API æ¸¬è©¦æˆåŠŸï¼ˆcurl å‘½ä»¤ï¼‰
- [ ] è¨ªå• `/` è‡ªå‹•é‡å®šå‘åˆ° `/login`
- [ ] ç™»å…¥é é¢æ­£å¸¸é¡¯ç¤º
- [ ] è¼¸å…¥æ­£ç¢ºçš„ç”¨æˆ¶åå’Œå¯†ç¢¼å¯ä»¥ç™»å…¥
- [ ] Console é¡¯ç¤ºå®Œæ•´çš„ç™»å…¥æ—¥èªŒ
- [ ] Local Storage æ­£ç¢ºå„²å­˜ token å’Œ user
- [ ] ç™»å…¥å¾Œè·³è½‰åˆ° `/dashboard`
- [ ] Dashboard æ­£å¸¸é¡¯ç¤º
- [ ] Navbar é¡¯ç¤ºæ­£ç¢ºçš„ç”¨æˆ¶å
- [ ] é»æ“Šç™»å‡ºæŒ‰éˆ•å¯ä»¥ç™»å‡º
- [ ] ç™»å‡ºå¾Œè·³è½‰åˆ° `/login`
- [ ] ç™»å‡ºå¾Œ Local Storage è¢«æ¸…é™¤
- [ ] ç™»å‡ºå¾Œç„¡æ³•é€šéè¿”å›éµå›åˆ° Dashboard
- [ ] æœªç™»å…¥æ™‚è¨ªå• `/dashboard` è‡ªå‹•é‡å®šå‘åˆ° `/login`
- [ ] è¼¸å…¥éŒ¯èª¤çš„ç”¨æˆ¶åæˆ–å¯†ç¢¼é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯

---

## ğŸš€ å¿«é€Ÿæ¸¬è©¦å‘½ä»¤

åŸ·è¡Œæ‰¹æ¬¡æª”é€²è¡Œå®Œæ•´æ¸¬è©¦ï¼š
```bash
test-auth-flow.bat
```

---

**ä¿®å¾©å®Œæˆæ™‚é–“**ï¼š2026-02-04
**æ¸¬è©¦ç‹€æ…‹**ï¼šâœ… å¾…ç”¨æˆ¶é©—è­‰
