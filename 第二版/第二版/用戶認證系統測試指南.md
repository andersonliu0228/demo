# ç”¨æˆ¶èªè­‰ç³»çµ±æ¸¬è©¦æŒ‡å—

## æ¦‚è¿°

ç³»çµ±ç¾åœ¨å…·å‚™å®Œæ•´çš„ç”¨æˆ¶èªè­‰åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- âœ… ç”¨æˆ¶è¨»å†Š
- âœ… ç”¨æˆ¶ç™»å…¥ï¼ˆJWT Tokenï¼‰
- âœ… Token é©—è­‰
- âœ… æˆ‘çš„å°ˆå€ API
- âœ… äº¤æ˜“è¨˜éŒ„æŸ¥è©¢

## å¿«é€Ÿé–‹å§‹

### æ­¥é©Ÿ 1: è¨»å†Šæ–°ç”¨æˆ¶

```powershell
curl.exe -X POST http://localhost:8000/api/v1/auth/register `
  -H "Content-Type: application/json" `
  -d '{\"username\":\"testuser\",\"email\":\"test@example.com\",\"password\":\"password123\"}'
```

**é æœŸè¼¸å‡º**ï¼š
```json
{
  "id": 1,
  "username": "testuser",
  "email": "test@example.com",
  "is_active": true,
  "created_at": "2026-02-03T..."
}
```

### æ­¥é©Ÿ 2: ç”¨æˆ¶ç™»å…¥

```powershell
curl.exe -X POST http://localhost:8000/api/v1/auth/login `
  -H "Content-Type: application/x-www-form-urlencoded" `
  -d "username=testuser&password=password123"
```

**é æœŸè¼¸å‡º**ï¼š
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

**é‡è¦**ï¼šä¿å­˜é€™å€‹ `access_token`ï¼Œå¾ŒçºŒè«‹æ±‚éœ€è¦ä½¿ç”¨ï¼

### æ­¥é©Ÿ 3: æŸ¥çœ‹æˆ‘çš„å¸³è™Ÿç‹€æ…‹

```powershell
# å°‡ YOUR_TOKEN æ›¿æ›ç‚ºæ­¥é©Ÿ 2 ç²å¾—çš„ access_token
curl.exe -X GET http://localhost:8000/api/v1/user/me `
  -H "Authorization: Bearer YOUR_TOKEN"
```

**é æœŸè¼¸å‡º**ï¼š
```json
{
  "id": 1,
  "username": "testuser",
  "email": "test@example.com",
  "is_active": true,
  "created_at": "2026-02-03T...",
  "updated_at": "2026-02-03T..."
}
```

### æ­¥é©Ÿ 4: æŸ¥çœ‹æˆ‘çš„äº¤æ˜“è¨˜éŒ„

```powershell
curl.exe -X GET http://localhost:8000/api/v1/user/trades `
  -H "Authorization: Bearer YOUR_TOKEN"
```

**é æœŸè¼¸å‡º**ï¼š
```json
{
  "total": 0,
  "trades": []
}
```

### æ­¥é©Ÿ 5: æŸ¥çœ‹æˆ‘çš„çµ±è¨ˆè³‡è¨Š

```powershell
curl.exe -X GET http://localhost:8000/api/v1/user/stats `
  -H "Authorization: Bearer YOUR_TOKEN"
```

**é æœŸè¼¸å‡º**ï¼š
```json
{
  "user_id": 1,
  "username": "testuser",
  "as_master": {
    "total_trades": 0,
    "successful_trades": 0,
    "failed_trades": 0,
    "success_rate": 0,
    "followers_count": 0
  },
  "as_follower": {
    "total_trades": 0,
    "successful_trades": 0,
    "failed_trades": 0,
    "success_rate": 0,
    "following_count": 0
  },
  "credentials_count": 0
}
```

## åœ¨ Swagger UI ä¸­æ¸¬è©¦

è¨ªå• http://localhost:8000/docs

### å®Œæ•´æµç¨‹

1. **POST /api/v1/auth/register** - è¨»å†Šæ–°ç”¨æˆ¶
   ```json
   {
     "username": "testuser",
     "email": "test@example.com",
     "password": "password123"
   }
   ```

2. **POST /api/v1/auth/login** - ç™»å…¥ç²å– Token
   - é»æ“Š "Try it out"
   - è¼¸å…¥ username å’Œ password
   - é»æ“Š "Execute"
   - **è¤‡è£½è¿”å›çš„ access_token**

3. **é»æ“Šé é¢å³ä¸Šè§’çš„ "Authorize" æŒ‰éˆ•**
   - åœ¨å½ˆå‡ºçš„å°è©±æ¡†ä¸­è¼¸å…¥ï¼š`Bearer YOUR_TOKEN`
   - é»æ“Š "Authorize"
   - é»æ“Š "Close"

4. **ç¾åœ¨å¯ä»¥è¨ªå•éœ€è¦èªè­‰çš„ API**
   - GET /api/v1/user/me - æŸ¥çœ‹æˆ‘çš„è³‡è¨Š
   - GET /api/v1/user/trades - æŸ¥çœ‹æˆ‘çš„äº¤æ˜“
   - GET /api/v1/user/stats - æŸ¥çœ‹æˆ‘çš„çµ±è¨ˆ
   - GET /api/v1/user/following - æŸ¥çœ‹æˆ‘æ­£åœ¨è·Ÿéš¨çš„ Master
   - GET /api/v1/user/followers - æŸ¥çœ‹æˆ‘çš„è·Ÿéš¨è€…

## API ç«¯é»ç¸½è¦½

### èªè­‰ç›¸é—œ

| ç«¯é» | æ–¹æ³• | èªªæ˜ | éœ€è¦èªè­‰ |
|------|------|------|----------|
| /api/v1/auth/register | POST | è¨»å†Šæ–°ç”¨æˆ¶ | âŒ |
| /api/v1/auth/login | POST | ç”¨æˆ¶ç™»å…¥ | âŒ |
| /api/v1/auth/me | GET | ç²å–ç•¶å‰ç”¨æˆ¶è³‡è¨Š | âœ… |
| /api/v1/auth/logout | POST | ç”¨æˆ¶ç™»å‡º | âœ… |

### æˆ‘çš„å°ˆå€

| ç«¯é» | æ–¹æ³• | èªªæ˜ | éœ€è¦èªè­‰ |
|------|------|------|----------|
| /api/v1/user/me | GET | æŸ¥çœ‹æˆ‘çš„å¸³è™Ÿç‹€æ…‹ | âœ… |
| /api/v1/user/trades | GET | æŸ¥çœ‹æˆ‘çš„è·Ÿå–®æ­·å² | âœ… |
| /api/v1/user/stats | GET | æŸ¥çœ‹æˆ‘çš„çµ±è¨ˆè³‡è¨Š | âœ… |
| /api/v1/user/following | GET | æŸ¥çœ‹æˆ‘æ­£åœ¨è·Ÿéš¨çš„ Master | âœ… |
| /api/v1/user/followers | GET | æŸ¥çœ‹æˆ‘çš„è·Ÿéš¨è€… | âœ… |

## å®Œæ•´æ¸¬è©¦å ´æ™¯

### å ´æ™¯ 1: æ–°ç”¨æˆ¶è¨»å†Šä¸¦æŸ¥çœ‹è³‡è¨Š

```powershell
# 1. è¨»å†Š
$registerResponse = curl.exe -X POST http://localhost:8000/api/v1/auth/register `
  -H "Content-Type: application/json" `
  -d '{\"username\":\"alice\",\"email\":\"alice@example.com\",\"password\":\"alice123\"}'

# 2. ç™»å…¥
$loginResponse = curl.exe -X POST http://localhost:8000/api/v1/auth/login `
  -H "Content-Type: application/x-www-form-urlencoded" `
  -d "username=alice&password=alice123"

# 3. æå– tokenï¼ˆéœ€è¦æ‰‹å‹•è¤‡è£½ï¼‰
# å‡è¨­ token æ˜¯: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# 4. æŸ¥çœ‹æˆ‘çš„è³‡è¨Š
curl.exe -X GET http://localhost:8000/api/v1/user/me `
  -H "Authorization: Bearer YOUR_TOKEN"
```

### å ´æ™¯ 2: å‰µå»ºè·Ÿéš¨é—œä¿‚ä¸¦æŸ¥çœ‹çµ±è¨ˆ

```powershell
# å‡è¨­å·²ç¶“ç™»å…¥ä¸¦ç²å¾— token

# 1. å‰µå»º Master æ†‘è­‰
curl.exe -X POST http://localhost:8000/api/v1/credentials `
  -H "Authorization: Bearer YOUR_TOKEN" `
  -H "Content-Type: application/json" `
  -d '{\"user_id\":1,\"exchange_name\":\"mock\",\"api_key\":\"master_key\",\"api_secret\":\"master_secret\",\"label\":\"My Master\"}'

# 2. å‰µå»º Follower æ†‘è­‰
curl.exe -X POST http://localhost:8000/api/v1/credentials `
  -H "Authorization: Bearer YOUR_TOKEN" `
  -H "Content-Type: application/json" `
  -d '{\"user_id\":2,\"exchange_name\":\"mock\",\"api_key\":\"follower_key\",\"api_secret\":\"follower_secret\",\"label\":\"My Follower\"}'

# 3. å‰µå»ºè·Ÿéš¨é—œä¿‚
curl.exe -X POST http://localhost:8000/api/v1/follower/relationships `
  -H "Authorization: Bearer YOUR_TOKEN" `
  -H "Content-Type: application/json" `
  -d '{\"follower_user_id\":2,\"master_user_id\":1,\"follow_ratio\":0.1,\"follower_credential_id\":2,\"master_credential_id\":1}'

# 4. æŸ¥çœ‹çµ±è¨ˆ
curl.exe -X GET http://localhost:8000/api/v1/user/stats `
  -H "Authorization: Bearer YOUR_TOKEN"
```

### å ´æ™¯ 3: æŸ¥çœ‹æˆ‘çš„äº¤æ˜“è¨˜éŒ„

```powershell
# 1. å•Ÿå‹•ç›£æ§å¼•æ“
curl.exe -X POST http://localhost:8000/api/v1/follower/engine/start `
  -H "Authorization: Bearer YOUR_TOKEN"

# 2. è§¸ç™¼ Master è¨‚å–®
curl.exe -X POST "http://localhost:8000/api/v1/test/trigger-master-order?position_size=1.0&entry_price=50000" `
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. ç­‰å¾… 4 ç§’
Start-Sleep -Seconds 4

# 4. æŸ¥çœ‹æˆ‘çš„äº¤æ˜“è¨˜éŒ„
curl.exe -X GET http://localhost:8000/api/v1/user/trades `
  -H "Authorization: Bearer YOUR_TOKEN"

# 5. åªæŸ¥çœ‹ä½œç‚º Follower çš„è¨˜éŒ„
curl.exe -X GET "http://localhost:8000/api/v1/user/trades?as_follower=true" `
  -H "Authorization: Bearer YOUR_TOKEN"

# 6. åªæŸ¥çœ‹ä½œç‚º Master çš„è¨˜éŒ„
curl.exe -X GET "http://localhost:8000/api/v1/user/trades?as_master=true" `
  -H "Authorization: Bearer YOUR_TOKEN"
```

## æ•¸æ“šåº«é—œè¯

### trade_logs è¡¨é—œè¯

æ¯ä¸€ç­† `trade_log` éƒ½æ­£ç¢ºæ­¸å±¬åˆ°ç‰¹å®šçš„ `user_id`ï¼š

```sql
-- Master ç”¨æˆ¶çš„äº¤æ˜“è¨˜éŒ„
SELECT * FROM trade_logs WHERE master_user_id = 1;

-- Follower ç”¨æˆ¶çš„äº¤æ˜“è¨˜éŒ„
SELECT * FROM trade_logs WHERE follower_user_id = 2;

-- æŸå€‹ç”¨æˆ¶çš„æ‰€æœ‰ç›¸é—œäº¤æ˜“ï¼ˆä½œç‚º Master æˆ– Followerï¼‰
SELECT * FROM trade_logs 
WHERE master_user_id = 1 OR follower_user_id = 1;
```

### æ•¸æ“šå®Œæ•´æ€§

- âœ… æ¯å€‹ trade_log éƒ½æœ‰ `master_user_id` å’Œ `follower_user_id`
- âœ… å¤–éµç´„æŸç¢ºä¿ç”¨æˆ¶å­˜åœ¨
- âœ… API è‡ªå‹•éæ¿¾ç•¶å‰ç”¨æˆ¶çš„è¨˜éŒ„

## JWT Token èªªæ˜

### Token çµæ§‹

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTcwOTQ4MDAwMH0.signature
```

- **Header**: ç®—æ³•å’Œé¡å‹
- **Payload**: ç”¨æˆ¶åå’ŒéæœŸæ™‚é–“
- **Signature**: ç°½å

### Token éæœŸæ™‚é–“

- é è¨­ï¼š30 åˆ†é˜
- å¯åœ¨ `.env` ä¸­é…ç½® `ACCESS_TOKEN_EXPIRE_MINUTES`

### Token ä½¿ç”¨æ–¹å¼

åœ¨ HTTP Header ä¸­æ·»åŠ ï¼š
```
Authorization: Bearer YOUR_TOKEN
```

## å®‰å…¨æ€§

### å¯†ç¢¼åŠ å¯†

- ä½¿ç”¨ bcrypt åŠ å¯†
- å¯†ç¢¼ä¸æœƒä»¥æ˜æ–‡å­˜å„²
- å¯†ç¢¼ä¸æœƒåœ¨ API éŸ¿æ‡‰ä¸­è¿”å›

### Token å®‰å…¨

- ä½¿ç”¨ HS256 ç®—æ³•
- SECRET_KEY æ‡‰åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­æ›´æ”¹
- Token åŒ…å«éæœŸæ™‚é–“

### å»ºè­°

1. **ç”Ÿç”¢ç’°å¢ƒ**ï¼š
   - æ›´æ”¹ `SECRET_KEY`
   - ä½¿ç”¨ HTTPS
   - è¨­ç½®é©ç•¶çš„ Token éæœŸæ™‚é–“

2. **å¯†ç¢¼ç­–ç•¥**ï¼š
   - æœ€å°‘ 8 å€‹å­—ç¬¦
   - åŒ…å«å¤§å°å¯«å­—æ¯ã€æ•¸å­—å’Œç‰¹æ®Šå­—ç¬¦

## æ•…éšœæ’é™¤

### å•é¡Œ 1: 401 Unauthorized

**åŸå› **ï¼šToken ç„¡æ•ˆæˆ–éæœŸ

**è§£æ±º**ï¼š
1. é‡æ–°ç™»å…¥ç²å–æ–° Token
2. ç¢ºèª Token æ ¼å¼æ­£ç¢ºï¼ˆBearer + ç©ºæ ¼ + Tokenï¼‰

### å•é¡Œ 2: è¨»å†Šå¤±æ•— - ç”¨æˆ¶åå·²å­˜åœ¨

**åŸå› **ï¼šç”¨æˆ¶åæˆ–éƒµä»¶å·²è¢«ä½¿ç”¨

**è§£æ±º**ï¼šä½¿ç”¨ä¸åŒçš„ç”¨æˆ¶åæˆ–éƒµä»¶

### å•é¡Œ 3: ç„¡æ³•è¨ªå• /user/me

**åŸå› **ï¼šæœªæä¾› Token æˆ– Token ç„¡æ•ˆ

**è§£æ±º**ï¼š
1. ç¢ºèªå·²ç™»å…¥
2. åœ¨ Header ä¸­æ·»åŠ  `Authorization: Bearer YOUR_TOKEN`

## ç¸½çµ

### æ ¸å¿ƒåŠŸèƒ½

1. âœ… **ç”¨æˆ¶è¨»å†Š** - å‰µå»ºæ–°å¸³è™Ÿ
2. âœ… **ç”¨æˆ¶ç™»å…¥** - ç²å– JWT Token
3. âœ… **Token é©—è­‰** - ä¿è­· API ç«¯é»
4. âœ… **æˆ‘çš„å°ˆå€** - æŸ¥çœ‹å€‹äººè³‡è¨Šå’Œçµ±è¨ˆ
5. âœ… **äº¤æ˜“è¨˜éŒ„** - æŸ¥çœ‹è·Ÿå–®æ­·å²
6. âœ… **æ•¸æ“šé—œè¯** - æ‰€æœ‰è¨˜éŒ„æ­£ç¢ºæ­¸å±¬åˆ°ç”¨æˆ¶

### ä¸‹ä¸€æ­¥

- æ·»åŠ å¯†ç¢¼é‡ç½®åŠŸèƒ½
- å¯¦ä½œ Refresh Token
- æ·»åŠ ç”¨æˆ¶è§’è‰²å’Œæ¬Šé™
- å¯¦ä½œ OAuth2 ç¬¬ä¸‰æ–¹ç™»å…¥

ç³»çµ±å·²å®Œå…¨å°±ç·’ï¼Œé–‹å§‹æ¸¬è©¦å§ï¼ğŸš€
