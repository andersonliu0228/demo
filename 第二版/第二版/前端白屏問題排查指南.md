# 前端白屏問題排查指南

## 🎯 最新修復（2026-02-04）

### 核心改進
1. **用戶狀態管理**：使用 `useState` 管理用戶狀態，確保響應式更新
2. **自動重載**：監聽路由變化和 localStorage 變化，自動更新用戶狀態
3. **安全渲染**：Navbar 只在已登入且非認證頁面時顯示
4. **預設值保護**：用戶名使用 `user.username || 'User'` 防止 undefined
5. **調試日誌**：添加詳細的 console.log 便於問題排查

---

## 🚀 快速修復步驟

### 1. 重啟前端容器
```bash
# 使用批次檔（推薦）
fix-and-test-frontend.bat

# 或手動執行
docker-compose restart frontend
```

### 2. 等待啟動
等待 15-20 秒讓 Vite 開發服務器完全啟動

### 3. 清除瀏覽器快取
- 按 `Ctrl + Shift + Delete`
- 選擇「快取的圖片和檔案」
- 點擊「清除資料」

### 4. 測試訪問
打開瀏覽器訪問 `http://localhost:3000`

---

## 🔍 問題診斷流程

### 步驟 1：檢查容器狀態
```bash
docker ps --filter "name=frontend"
```

**預期結果**：
- 容器狀態為 `Up`
- 端口映射為 `0.0.0.0:3000->3000/tcp`

**如果容器未運行**：
```bash
docker-compose up -d frontend
```

### 步驟 2：檢查前端日誌
```bash
docker logs --tail=50 ea_trading_frontend
```

**正常日誌應包含**：
```
VITE v4.x.x  ready in xxx ms
➜  Local:   http://localhost:3000/
➜  Network: http://0.0.0.0:3000/
```

**常見錯誤**：
- `EADDRINUSE`：端口被占用
- `Module not found`：依賴未安裝
- `Syntax error`：代碼語法錯誤

### 步驟 3：檢查瀏覽器控制台

#### 打開開發者工具
按 `F12` 或右鍵 → 檢查

#### Console 標籤
**正常日誌**：
```
✅ 後端連線成功
ℹ️ 用戶未登入
```

**登入後**：
```
✅ 用戶已登入: testuser
```

**登出後**：
```
✅ 已登出，清除 Token 和用戶資訊
ℹ️ 用戶未登入
```

**常見錯誤**：
- `Failed to fetch`：後端未運行或 CORS 問題
- `Unexpected token`：JSON 解析錯誤
- `Cannot read property 'username' of null`：用戶狀態問題

#### Network 標籤
檢查以下請求：
1. `http://localhost:3000/` - 應該返回 200
2. `http://localhost:8000/health` - 應該返回 200
3. `http://localhost:8000/api/v1/auth/login` - 登入時應該返回 200

**如果請求失敗**：
- 檢查後端容器是否運行
- 檢查 CORS 配置
- 檢查網絡連接

#### Application 標籤
檢查 Local Storage：

**登入前**：
- 應該為空或只有舊數據

**登入後**：
```
token: "eyJ0eXAiOiJKV1QiLCJhbGc..."
user: {"id":1,"username":"testuser"}
```

**登出後**：
- token 和 user 應該被清除

### 步驟 4：檢查路由行為

#### 測試 1：根路徑
訪問 `http://localhost:3000/`

**預期**：自動重定向到 `/login`

#### 測試 2：登入頁面
訪問 `http://localhost:3000/login`

**預期**：
- 顯示登入表單
- 沒有 Navbar
- 右上角有 API 連接狀態指示器

#### 測試 3：Dashboard（未登入）
訪問 `http://localhost:3000/dashboard`

**預期**：自動重定向到 `/login`

#### 測試 4：Dashboard（已登入）
登入後訪問 `http://localhost:3000/dashboard`

**預期**：
- 顯示 Dashboard 內容
- 頂部有 Navbar
- Navbar 顯示用戶名
- 右上角有登出按鈕

---

## 🐛 常見問題與解決方案

### 問題 1：白屏，控制台無錯誤

**可能原因**：
- React 組件渲染失敗
- CSS 未載入
- JavaScript 未執行

**解決方案**：
1. 檢查瀏覽器是否支持 ES6+
2. 清除瀏覽器快取
3. 檢查 Vite 配置
4. 重啟前端容器

### 問題 2：白屏，控制台有錯誤

**錯誤：`Cannot read property 'username' of null`**

**原因**：用戶狀態為 null 但嘗試訪問 username

**解決方案**：
- 已在最新版本修復
- 使用 `user.username || 'User'` 提供預設值

**錯誤：`Failed to fetch`**

**原因**：無法連接到後端 API

**解決方案**：
1. 檢查後端容器是否運行：`docker ps`
2. 測試後端 API：`curl http://localhost:8000/health`
3. 檢查 CORS 配置

**錯誤：`Unexpected token < in JSON`**

**原因**：API 返回 HTML 而非 JSON（通常是 404 或 500 錯誤）

**解決方案**：
1. 檢查 API 端點是否正確
2. 檢查後端日誌
3. 使用 Postman 測試 API

### 問題 3：登入後仍然白屏

**可能原因**：
- Dashboard 組件渲染失敗
- API 請求失敗
- 用戶狀態未更新

**解決方案**：
1. 檢查 Console 是否有 `✅ 用戶已登入` 日誌
2. 檢查 Local Storage 是否有 token 和 user
3. 檢查 Dashboard 組件的 API 請求
4. 檢查後端 `/api/v1/dashboard` 端點

### 問題 4：Navbar 不顯示

**可能原因**：
- 用戶狀態為 null
- 在認證頁面（/login 或 /register）
- Navbar 組件渲染失敗

**解決方案**：
1. 檢查 Console 日誌確認用戶狀態
2. 確認當前路由不是 /login 或 /register
3. 檢查 Navbar 組件是否有錯誤

### 問題 5：登出後可以返回 Dashboard

**原因**：未使用 `replace: true`

**解決方案**：
- 已在最新版本修復
- Navbar 的 handleLogout 使用 `navigate('/login', { replace: true })`

### 問題 6：跨標籤頁不同步

**原因**：未監聽 storage 事件

**解決方案**：
- 已在最新版本修復
- App.jsx 監聽 `storage` 事件自動更新用戶狀態

---

## 📊 完整測試流程

### 1. 環境準備
```bash
# 確保所有容器運行
docker-compose ps

# 如果有容器未運行
docker-compose up -d
```

### 2. 清除舊數據
```bash
# 清除瀏覽器 Local Storage
# 在瀏覽器 Console 執行：
localStorage.clear()
```

### 3. 測試未登入狀態
1. 訪問 `http://localhost:3000`
2. **預期**：顯示登入頁面
3. **檢查**：
   - 沒有 Navbar
   - 有登入表單
   - Console 顯示 `ℹ️ 用戶未登入`

### 4. 測試登入流程
1. 輸入用戶名：`testuser`
2. 輸入密碼：`testpass123`
3. 點擊「登入」按鈕
4. **預期**：
   - 跳轉到 `/dashboard`
   - 顯示 Navbar
   - Navbar 顯示 "testuser"
   - Console 顯示 `✅ 用戶已登入: testuser`
5. **檢查 Local Storage**：
   - 有 `token` 鍵
   - 有 `user` 鍵，值為 `{"id":1,"username":"testuser"}`

### 5. 測試 Dashboard 功能
1. 檢查 Dashboard 是否正常顯示
2. 檢查統計卡片是否有數據
3. 檢查倉位列表是否顯示
4. 檢查交易歷史是否顯示

### 6. 測試登出流程
1. 點擊右上角「登出」按鈕
2. **預期**：
   - 立即跳轉到 `/login`
   - Navbar 消失
   - Console 顯示 `✅ 已登出，清除 Token 和用戶資訊`
   - Console 顯示 `ℹ️ 用戶未登入`
3. **檢查 Local Storage**：
   - `token` 和 `user` 應該被清除
4. **測試返回鍵**：
   - 點擊瀏覽器返回鍵
   - **預期**：無法返回到 Dashboard

### 7. 測試路由保護
1. 登出後，手動訪問 `http://localhost:3000/dashboard`
2. **預期**：自動重定向到 `/login`

---

## 🛠️ 高級調試

### 啟用 React DevTools
1. 安裝 React Developer Tools 瀏覽器擴展
2. 打開開發者工具的 Components 標籤
3. 檢查組件樹和 props/state

### 檢查 Vite 配置
```bash
# 進入前端容器
docker exec -it ea_trading_frontend sh

# 檢查 Vite 配置
cat vite.config.js

# 檢查環境變數
env | grep VITE
```

### 檢查網絡請求
使用 Chrome DevTools 的 Network 標籤：
1. 勾選「Preserve log」
2. 勾選「Disable cache」
3. 重新載入頁面
4. 檢查所有請求的狀態碼和響應

### 檢查 CORS
如果看到 CORS 錯誤：
```python
# 檢查後端 main.py 的 CORS 配置
# 應該包含：
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

## 📝 修復歷史

### 2026-02-04 - 第二次修復
- 使用 useState 管理用戶狀態
- 監聽路由變化自動重載用戶資訊
- 監聽 storage 事件實現跨標籤頁同步
- 添加詳細的 console.log
- 確保 Navbar 只在正確時機顯示

### 2026-02-04 - 第一次修復
- 將 Navbar 移到 App.jsx 層級
- 修改根路徑重定向到 /login
- 使用 replace: true 防止返回
- 添加用戶資訊安全解析

---

## ✅ 驗證清單

完成以下所有項目，確認問題已解決：

- [ ] 訪問 `http://localhost:3000` 顯示登入頁面（不是白屏）
- [ ] 登入頁面沒有 Navbar
- [ ] 可以成功登入
- [ ] 登入後跳轉到 Dashboard
- [ ] Dashboard 顯示 Navbar
- [ ] Navbar 顯示正確的用戶名
- [ ] Dashboard 顯示統計數據
- [ ] 可以點擊登出按鈕
- [ ] 登出後返回登入頁面
- [ ] 登出後無法通過返回鍵回到 Dashboard
- [ ] 登出後 Local Storage 被清除
- [ ] 手動訪問 /dashboard 會重定向到 /login
- [ ] Console 沒有錯誤訊息
- [ ] Network 請求都成功（200 狀態碼）

---

**如果完成所有步驟後問題仍未解決，請提供：**
1. 瀏覽器 Console 的完整錯誤訊息
2. Network 標籤的失敗請求截圖
3. Docker 前端容器的日誌
4. 具體的問題描述（什麼時候發生、看到什麼）
