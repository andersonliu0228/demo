# 前端整合範例

## React/Next.js 整合

### 1. 安裝依賴

```bash
npm install axios
# 或
yarn add axios
```

### 2. 創建 API 客戶端

```typescript
// lib/api.ts
import axios from 'axios';

const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';

// 創建 axios 實例
export const apiClient = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
  withCredentials: true, // 允許發送 cookies
});

// 請求攔截器：自動添加 Token
apiClient.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// 響應攔截器：處理錯誤
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // Token 過期，跳轉到登入頁
      localStorage.removeItem('token');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);
```

### 3. 定義 TypeScript 類型

```typescript
// types/dashboard.ts
export interface PositionSummary {
  symbol: string;
  position_size: number;
  entry_price: number | null;
  current_value: number;
}

export interface MasterActivity {
  symbol: string;
  action: string;
  position_size: number;
  entry_price: number | null;
  timestamp: string;
}

export interface EngineStatus {
  is_running: boolean;
  status: 'Running' | 'Stopped';
  poll_interval: number;
}

export interface RecentTrade {
  id: number;
  timestamp: string;
  symbol: string;
  action: string;
  side: string;
  amount: number;
  status: string;
  execution_time_ms: number | null;
}

export interface DashboardSummary {
  user_id: number;
  username: string;
  is_active: boolean;
  follow_ratio: number;
  master_user_id: number | null;
  total_position_value: number;
  my_positions: PositionSummary[];
  master_latest_activity: MasterActivity | null;
  master_positions: PositionSummary[];
  engine_status: EngineStatus;
  recent_successful_trades: RecentTrade[];
  has_unresolved_errors: boolean;
  unresolved_error_count: number;
}
```

### 4. 創建 API 服務

```typescript
// services/dashboardService.ts
import { apiClient } from '@/lib/api';
import { DashboardSummary } from '@/types/dashboard';

export const dashboardService = {
  // 獲取儀表板摘要
  async getSummary(): Promise<DashboardSummary> {
    const response = await apiClient.get<DashboardSummary>('/api/v1/dashboard/summary');
    return response.data;
  },

  // 觸發 Master 訂單（測試用）
  async triggerMasterOrder(params: {
    master_user_id?: number;
    master_credential_id?: number;
    symbol?: string;
    position_size: number;
    entry_price: number;
  }) {
    const response = await apiClient.post('/api/v1/test/trigger-master-order', params);
    return response.data;
  },
};
```

### 5. 創建自定義 Hook

```typescript
// hooks/useDashboard.ts
import { useState, useEffect, useCallback } from 'react';
import { dashboardService } from '@/services/dashboardService';
import { DashboardSummary } from '@/types/dashboard';

export function useDashboard(refreshInterval: number = 5000) {
  const [dashboard, setDashboard] = useState<DashboardSummary | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const fetchDashboard = useCallback(async () => {
    try {
      setLoading(true);
      const data = await dashboardService.getSummary();
      setDashboard(data);
      setError(null);
    } catch (err: any) {
      setError(err.message || '獲取儀表板數據失敗');
      console.error('Dashboard fetch error:', err);
    } finally {
      setLoading(false);
    }
  }, []);

  // 初始載入
  useEffect(() => {
    fetchDashboard();
  }, [fetchDashboard]);

  // 定期刷新
  useEffect(() => {
    if (refreshInterval > 0) {
      const interval = setInterval(fetchDashboard, refreshInterval);
      return () => clearInterval(interval);
    }
  }, [refreshInterval, fetchDashboard]);

  return {
    dashboard,
    loading,
    error,
    refresh: fetchDashboard,
  };
}
```

### 6. 創建儀表板組件

```typescript
// components/Dashboard.tsx
'use client';

import { useDashboard } from '@/hooks/useDashboard';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Loader2 } from 'lucide-react';

export function Dashboard() {
  const { dashboard, loading, error, refresh } = useDashboard(5000);

  if (loading && !dashboard) {
    return (
      <div className="flex items-center justify-center h-screen">
        <Loader2 className="w-8 h-8 animate-spin" />
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="text-red-500">錯誤: {error}</div>
      </div>
    );
  }

  if (!dashboard) return null;

  return (
    <div className="container mx-auto p-6 space-y-6">
      {/* 標題欄 */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">EA Trading 儀表板</h1>
          <p className="text-gray-500">歡迎回來，{dashboard.username}</p>
        </div>
        <div className="flex items-center gap-4">
          <Badge variant={dashboard.is_active ? 'success' : 'secondary'}>
            {dashboard.is_active ? '跟單啟用' : '跟單停用'}
          </Badge>
          <Badge variant={dashboard.engine_status.is_running ? 'success' : 'destructive'}>
            引擎: {dashboard.engine_status.status}
          </Badge>
        </div>
      </div>

      {/* 統計卡片 */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardHeader>
            <CardTitle className="text-sm font-medium">總持倉價值</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              ${dashboard.total_position_value.toLocaleString()}
            </div>
            <p className="text-xs text-gray-500">USDT</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="text-sm font-medium">跟單比例</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {(dashboard.follow_ratio * 100).toFixed(1)}%
            </div>
            <p className="text-xs text-gray-500">Master 倉位的比例</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="text-sm font-medium">我的倉位</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{dashboard.my_positions.length}</div>
            <p className="text-xs text-gray-500">個交易對</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="text-sm font-medium">成功交易</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {dashboard.recent_successful_trades.length}
            </div>
            <p className="text-xs text-gray-500">最近 5 筆</p>
          </CardContent>
        </Card>
      </div>

      {/* 倉位對比 */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* 我的倉位 */}
        <Card>
          <CardHeader>
            <CardTitle>我的倉位</CardTitle>
          </CardHeader>
          <CardContent>
            {dashboard.my_positions.length === 0 ? (
              <p className="text-gray-500">暫無倉位</p>
            ) : (
              <div className="space-y-3">
                {dashboard.my_positions.map((pos) => (
                  <div
                    key={pos.symbol}
                    className="flex items-center justify-between p-3 bg-gray-50 rounded-lg"
                  >
                    <div>
                      <div className="font-medium">{pos.symbol}</div>
                      <div className="text-sm text-gray-500">
                        {pos.position_size} @ ${pos.entry_price?.toLocaleString()}
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="font-bold">${pos.current_value.toLocaleString()}</div>
                      <div className="text-xs text-gray-500">USDT</div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>

        {/* Master 倉位 */}
        <Card>
          <CardHeader>
            <CardTitle>Master 倉位</CardTitle>
          </CardHeader>
          <CardContent>
            {dashboard.master_positions.length === 0 ? (
              <p className="text-gray-500">Master 暫無倉位</p>
            ) : (
              <div className="space-y-3">
                {dashboard.master_positions.map((pos) => (
                  <div
                    key={pos.symbol}
                    className="flex items-center justify-between p-3 bg-blue-50 rounded-lg"
                  >
                    <div>
                      <div className="font-medium">{pos.symbol}</div>
                      <div className="text-sm text-gray-500">
                        {pos.position_size} @ ${pos.entry_price?.toLocaleString()}
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="font-bold">${pos.current_value.toLocaleString()}</div>
                      <div className="text-xs text-gray-500">USDT</div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      {/* Master 最新動作 */}
      {dashboard.master_latest_activity && (
        <Card>
          <CardHeader>
            <CardTitle>Master 最新動作</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-between">
              <div>
                <div className="font-medium">{dashboard.master_latest_activity.symbol}</div>
                <div className="text-sm text-gray-500">
                  {dashboard.master_latest_activity.action}
                </div>
              </div>
              <div className="text-right">
                <div className="font-bold">
                  {dashboard.master_latest_activity.position_size}
                </div>
                <div className="text-xs text-gray-500">
                  {new Date(dashboard.master_latest_activity.timestamp).toLocaleString()}
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* 最近交易 */}
      <Card>
        <CardHeader>
          <CardTitle>最近成功交易</CardTitle>
        </CardHeader>
        <CardContent>
          {dashboard.recent_successful_trades.length === 0 ? (
            <p className="text-gray-500">暫無交易記錄</p>
          ) : (
            <div className="space-y-2">
              {dashboard.recent_successful_trades.map((trade) => (
                <div
                  key={trade.id}
                  className="flex items-center justify-between p-3 border-b last:border-0"
                >
                  <div>
                    <div className="font-medium">{trade.symbol}</div>
                    <div className="text-sm text-gray-500">{trade.action}</div>
                  </div>
                  <div className="text-right">
                    <div className="font-medium">
                      {trade.side === 'buy' ? '買入' : '賣出'} {trade.amount}
                    </div>
                    <div className="text-xs text-gray-500">
                      {trade.execution_time_ms}ms
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      {/* 錯誤提示 */}
      {dashboard.has_unresolved_errors && (
        <Card className="border-red-500">
          <CardHeader>
            <CardTitle className="text-red-500">⚠️ 有未解決的錯誤</CardTitle>
          </CardHeader>
          <CardContent>
            <p>
              您有 {dashboard.unresolved_error_count} 個未解決的交易錯誤，請前往錯誤管理頁面處理。
            </p>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
```

### 7. 使用組件

```typescript
// app/dashboard/page.tsx
import { Dashboard } from '@/components/Dashboard';

export default function DashboardPage() {
  return <Dashboard />;
}
```

---

## Vue 3 整合

### 1. 創建 API 服務

```typescript
// services/api.ts
import axios from 'axios';

const apiClient = axios.create({
  baseURL: import.meta.env.VITE_API_URL || 'http://localhost:8000',
  headers: {
    'Content-Type': 'application/json',
  },
  withCredentials: true,
});

apiClient.interceptors.request.use((config) => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

export const dashboardApi = {
  getSummary: () => apiClient.get('/api/v1/dashboard/summary'),
  triggerMasterOrder: (data: any) => apiClient.post('/api/v1/test/trigger-master-order', data),
};
```

### 2. 創建 Composable

```typescript
// composables/useDashboard.ts
import { ref, onMounted, onUnmounted } from 'vue';
import { dashboardApi } from '@/services/api';

export function useDashboard(refreshInterval = 5000) {
  const dashboard = ref(null);
  const loading = ref(true);
  const error = ref(null);
  let intervalId: number | null = null;

  const fetchDashboard = async () => {
    try {
      loading.value = true;
      const response = await dashboardApi.getSummary();
      dashboard.value = response.data;
      error.value = null;
    } catch (err: any) {
      error.value = err.message;
    } finally {
      loading.value = false;
    }
  };

  onMounted(() => {
    fetchDashboard();
    if (refreshInterval > 0) {
      intervalId = setInterval(fetchDashboard, refreshInterval);
    }
  });

  onUnmounted(() => {
    if (intervalId) {
      clearInterval(intervalId);
    }
  });

  return {
    dashboard,
    loading,
    error,
    refresh: fetchDashboard,
  };
}
```

### 3. 使用 Composable

```vue
<template>
  <div v-if="loading && !dashboard" class="loading">載入中...</div>
  <div v-else-if="error" class="error">{{ error }}</div>
  <div v-else-if="dashboard" class="dashboard">
    <h1>歡迎回來，{{ dashboard.username }}</h1>
    <div class="stats">
      <div class="stat-card">
        <h3>總持倉價值</h3>
        <p>${{ dashboard.total_position_value.toLocaleString() }}</p>
      </div>
      <!-- 其他統計卡片 -->
    </div>
  </div>
</template>

<script setup lang="ts">
import { useDashboard } from '@/composables/useDashboard';

const { dashboard, loading, error, refresh } = useDashboard(5000);
</script>
```

---

## 測試 CORS

在瀏覽器控制台執行：

```javascript
fetch('http://localhost:8000/api/v1/dashboard/summary', {
  method: 'GET',
  headers: {
    'Authorization': 'Bearer YOUR_TOKEN_HERE',
  },
})
  .then(res => res.json())
  .then(data => console.log(data))
  .catch(err => console.error(err));
```

如果看到 CORS 錯誤，檢查：
1. 後端 CORS 設定是否包含前端 URL
2. 是否使用了正確的 Headers
3. 是否設定了 `withCredentials: true`

---

## 環境變數設定

### React/Next.js (.env.local)
```
NEXT_PUBLIC_API_URL=http://localhost:8000
```

### Vue/Vite (.env)
```
VITE_API_URL=http://localhost:8000
```

---

## 生產環境部署

### 後端 CORS 設定更新

```python
# backend/app/main.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",
        "https://your-frontend-domain.com",  # 生產環境域名
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 前端環境變數

```
# 生產環境
NEXT_PUBLIC_API_URL=https://api.your-domain.com
```
