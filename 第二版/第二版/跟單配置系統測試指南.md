# è·Ÿå–®é…ç½®ç³»çµ±æ¸¬è©¦æŒ‡å—

## æ¦‚è¿°

ç³»çµ±ç¾åœ¨å…·å‚™å®Œæ•´çš„è·Ÿå–®é…ç½®åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- âœ… ç”¨æˆ¶ç´šåˆ¥çš„è·Ÿå–®è¨­å®šï¼ˆfollow_ratio, is_activeï¼‰
- âœ… å„ªåŒ–çš„èƒŒæ™¯ç›£æ§ä»»å‹™ï¼ˆå¾è³‡æ–™åº«è®€å–å•Ÿç”¨çš„ç”¨æˆ¶ï¼‰
- âœ… è·Ÿå–®ç‹€æ…‹å„€è¡¨æ¿ API
- âœ… é˜²éŒ¯æ©Ÿåˆ¶ï¼ˆè‡ªå‹•åœæ­¢è·Ÿå–®ä¸¦è¨˜éŒ„éŒ¯èª¤ï¼‰
- âœ… éŒ¯èª¤æ¢å¾©æ©Ÿåˆ¶ï¼ˆæ‰‹å‹•è§£æ±ºéŒ¯èª¤å¾Œè‡ªå‹•æ¢å¾©è·Ÿå–®ï¼‰

## æ–°å¢åŠŸèƒ½

### 1. Follow Settingsï¼ˆè·Ÿå–®è¨­å®šï¼‰
æ¯å€‹ç”¨æˆ¶å¯ä»¥è¨­å®šè‡ªå·±çš„è·Ÿå–®é…ç½®ï¼š
- `follow_ratio`: è·Ÿå–®æ¯”ä¾‹ï¼ˆä¾‹å¦‚ 0.1 = 10%ï¼‰
- `is_active`: æ˜¯å¦å•Ÿç”¨è·Ÿå–®
- `master_user_id`: è·Ÿéš¨çš„ Master ç”¨æˆ¶
- `master_credential_id`: Master çš„æ†‘è­‰
- `follower_credential_id`: è‡ªå·±çš„æ†‘è­‰

### 2. Trade Errorsï¼ˆäº¤æ˜“éŒ¯èª¤ï¼‰
è¨˜éŒ„æ‰€æœ‰äº¤æ˜“å¤±æ•—ï¼š
- è‡ªå‹•è¨˜éŒ„éŒ¯èª¤é¡å‹å’Œè©³ç´°è³‡è¨Š
- ç™¼ç”ŸéŒ¯èª¤æ™‚è‡ªå‹•åœæ­¢è©²ç”¨æˆ¶çš„è·Ÿå–®
- æ”¯æ´æ‰‹å‹•è§£æ±ºéŒ¯èª¤ä¸¦æ¢å¾©è·Ÿå–®

### 3. Follower Engine V2
å„ªåŒ–çš„ç›£æ§å¼•æ“ï¼š
- å¾è³‡æ–™åº«è®€å–æ‰€æœ‰ `is_active=True` çš„ç”¨æˆ¶
- æ ¹æ“šæ¯å€‹ç”¨æˆ¶çš„ `follow_ratio` è¨ˆç®—ä¸‹å–®é‡
- æª¢æŸ¥æœªè§£æ±ºçš„éŒ¯èª¤ï¼Œæœ‰éŒ¯èª¤æ™‚è·³éè·Ÿå–®
- äº¤æ˜“å¤±æ•—æ™‚è‡ªå‹•åœæ­¢è·Ÿå–®ä¸¦è¨˜éŒ„éŒ¯èª¤

## API ç«¯é»

### è·Ÿå–®é…ç½®ç®¡ç†

#### 1. å‰µå»ºè·Ÿå–®è¨­å®š
```bash
POST /api/v1/follow-config/settings
Authorization: Bearer YOUR_TOKEN
Content-Type: application/json

{
  "master_user_id": 1,
  "master_credential_id": 1,
  "follower_credential_id": 2,
  "follow_ratio": 0.1,
  "is_active": true
}
```

#### 2. ç²å–æˆ‘çš„è·Ÿå–®è¨­å®š
```bash
GET /api/v1/follow-config/settings
Authorization: Bearer YOUR_TOKEN
```

#### 3. æ›´æ–°æˆ‘çš„è·Ÿå–®è¨­å®š
```bash
PUT /api/v1/follow-config/settings
Authorization: Bearer YOUR_TOKEN
Content-Type: application/json

{
  "follow_ratio": 0.2,
  "is_active": false
}
```

#### 4. ç²å–è·Ÿå–®ç‹€æ…‹å„€è¡¨æ¿
```bash
GET /api/v1/follow-config/status
Authorization: Bearer YOUR_TOKEN
```

**éŸ¿æ‡‰ç¤ºä¾‹**:
```json
{
  "user_id": 2,
  "username": "alice",
  "is_active": true,
  "follow_ratio": 0.1,
  "master_user_id": 1,
  "has_unresolved_errors": false,
  "unresolved_error_count": 0,
  "my_positions": [],
  "master_positions": [
    {
      "symbol": "BTC/USDT",
      "position_size": 1.0,
      "entry_price": 50000.0,
      "last_updated": "2026-02-04T...",
      "expected_follower_size": 0.1
    }
  ]
}
```

#### 5. ç²å–æˆ‘çš„äº¤æ˜“éŒ¯èª¤
```bash
GET /api/v1/follow-config/errors
Authorization: Bearer YOUR_TOKEN
```

#### 6. è§£æ±ºéŒ¯èª¤ä¸¦æ¢å¾©è·Ÿå–®
```bash
POST /api/v1/follow-config/errors/{error_id}/resolve
Authorization: Bearer YOUR_TOKEN
```

## å®Œæ•´æ¸¬è©¦æµç¨‹

### æ­¥é©Ÿ 1: è¨»å†Šå…©å€‹ç”¨æˆ¶

```powershell
# è¨»å†Š Master ç”¨æˆ¶
curl.exe -X POST http://localhost:8000/api/v1/auth/register `
  -H "Content-Type: application/json" `
  -d '{\"username\":\"master\",\"email\":\"master@example.com\",\"password\":\"pass123\"}'

# è¨»å†Š Follower ç”¨æˆ¶
curl.exe -X POST http://localhost:8000/api/v1/auth/register `
  -H "Content-Type: application/json" `
  -d '{\"username\":\"follower\",\"email\":\"follower@example.com\",\"password\":\"pass123\"}'
```

### æ­¥é©Ÿ 2: ç™»å…¥ä¸¦ç²å– Token

```powershell
# Master ç™»å…¥
curl.exe -X POST http://localhost:8000/api/v1/auth/login `
  -H "Content-Type: application/x-www-form-urlencoded" `
  -d "username=master&password=pass123"

# Follower ç™»å…¥
curl.exe -X POST http://localhost:8000/api/v1/auth/login `
  -H "Content-Type: application/x-www-form-urlencoded" `
  -d "username=follower&password=pass123"
```

### æ­¥é©Ÿ 3: å‰µå»ºæ†‘è­‰

```powershell
# Master å‰µå»ºæ†‘è­‰ï¼ˆä½¿ç”¨ Master Tokenï¼‰
curl.exe -X POST http://localhost:8000/api/v1/credentials `
  -H "Authorization: Bearer MASTER_TOKEN" `
  -H "Content-Type: application/json" `
  -d '{\"exchange_name\":\"mock\",\"api_key\":\"master_key\",\"api_secret\":\"master_secret\",\"label\":\"Master Account\"}'

# Follower å‰µå»ºæ†‘è­‰ï¼ˆä½¿ç”¨ Follower Tokenï¼‰
curl.exe -X POST http://localhost:8000/api/v1/credentials `
  -H "Authorization: Bearer FOLLOWER_TOKEN" `
  -H "Content-Type: application/json" `
  -d '{\"exchange_name\":\"mock\",\"api_key\":\"follower_key\",\"api_secret\":\"follower_secret\",\"label\":\"Follower Account\"}'
```

### æ­¥é©Ÿ 4: å‰µå»ºè·Ÿå–®è¨­å®š

```powershell
# Follower å‰µå»ºè·Ÿå–®è¨­å®šï¼ˆä½¿ç”¨ Follower Tokenï¼‰
curl.exe -X POST http://localhost:8000/api/v1/follow-config/settings `
  -H "Authorization: Bearer FOLLOWER_TOKEN" `
  -H "Content-Type: application/json" `
  -d '{\"master_user_id\":1,\"master_credential_id\":1,\"follower_credential_id\":2,\"follow_ratio\":0.1,\"is_active\":true}'
```

### æ­¥é©Ÿ 5: å•Ÿå‹•ç›£æ§å¼•æ“

```powershell
# å•Ÿå‹• Follower Engineï¼ˆä½¿ç”¨ä»»æ„ Tokenï¼‰
curl.exe -X POST http://localhost:8000/api/v1/follower/engine/start `
  -H "Authorization: Bearer YOUR_TOKEN"
```

### æ­¥é©Ÿ 6: æ¨¡æ“¬ Master ä¸‹å–®

```powershell
# è§¸ç™¼ Master è¨‚å–®ï¼ˆä½¿ç”¨ Master Tokenï¼‰
curl.exe -X POST "http://localhost:8000/api/v1/test/trigger-master-order?position_size=1.0&entry_price=50000" `
  -H "Authorization: Bearer MASTER_TOKEN"
```

### æ­¥é©Ÿ 7: æŸ¥çœ‹è·Ÿå–®ç‹€æ…‹

```powershell
# æŸ¥çœ‹è·Ÿå–®ç‹€æ…‹ï¼ˆä½¿ç”¨ Follower Tokenï¼‰
curl.exe -X GET http://localhost:8000/api/v1/follow-config/status `
  -H "Authorization: Bearer FOLLOWER_TOKEN"
```

### æ­¥é©Ÿ 8: æŸ¥çœ‹äº¤æ˜“è¨˜éŒ„

```powershell
# æŸ¥çœ‹æˆ‘çš„äº¤æ˜“è¨˜éŒ„ï¼ˆä½¿ç”¨ Follower Tokenï¼‰
curl.exe -X GET http://localhost:8000/api/v1/user/trades `
  -H "Authorization: Bearer FOLLOWER_TOKEN"
```

### æ­¥é©Ÿ 9: æ¸¬è©¦éŒ¯èª¤è™•ç†

```powershell
# æŸ¥çœ‹éŒ¯èª¤è¨˜éŒ„ï¼ˆä½¿ç”¨ Follower Tokenï¼‰
curl.exe -X GET http://localhost:8000/api/v1/follow-config/errors `
  -H "Authorization: Bearer FOLLOWER_TOKEN"

# è§£æ±ºéŒ¯èª¤ï¼ˆä½¿ç”¨ Follower Tokenï¼‰
curl.exe -X POST http://localhost:8000/api/v1/follow-config/errors/1/resolve `
  -H "Authorization: Bearer FOLLOWER_TOKEN"
```

### æ­¥é©Ÿ 10: æ›´æ–°è·Ÿå–®è¨­å®š

```powershell
# åœç”¨è·Ÿå–®ï¼ˆä½¿ç”¨ Follower Tokenï¼‰
curl.exe -X PUT http://localhost:8000/api/v1/follow-config/settings `
  -H "Authorization: Bearer FOLLOWER_TOKEN" `
  -H "Content-Type: application/json" `
  -d '{\"is_active\":false}'

# ä¿®æ”¹è·Ÿå–®æ¯”ä¾‹ï¼ˆä½¿ç”¨ Follower Tokenï¼‰
curl.exe -X PUT http://localhost:8000/api/v1/follow-config/settings `
  -H "Authorization: Bearer FOLLOWER_TOKEN" `
  -H "Content-Type: application/json" `
  -d '{\"follow_ratio\":0.2,\"is_active\":true}'
```

## åœ¨ Swagger UI ä¸­æ¸¬è©¦

è¨ªå• http://localhost:8000/docs

### å®Œæ•´æµç¨‹

1. **è¨»å†Š Master å’Œ Follower ç”¨æˆ¶**
   - POST `/api/v1/auth/register`

2. **åˆ†åˆ¥ç™»å…¥ç²å– Token**
   - POST `/api/v1/auth/login`
   - ä¿å­˜å…©å€‹ Token

3. **å‰µå»ºæ†‘è­‰**
   - Master: POST `/api/v1/credentials`
   - Follower: POST `/api/v1/credentials`

4. **å‰µå»ºè·Ÿå–®è¨­å®š**
   - Follower: POST `/api/v1/follow-config/settings`

5. **å•Ÿå‹•ç›£æ§å¼•æ“**
   - POST `/api/v1/follower/engine/start`

6. **è§¸ç™¼ Master è¨‚å–®**
   - POST `/api/v1/test/trigger-master-order`

7. **æŸ¥çœ‹è·Ÿå–®ç‹€æ…‹**
   - GET `/api/v1/follow-config/status`

8. **æŸ¥çœ‹äº¤æ˜“è¨˜éŒ„**
   - GET `/api/v1/user/trades`

## æ ¸å¿ƒç‰¹æ€§

### 1. ç”¨æˆ¶ç´šåˆ¥é…ç½®
- æ¯å€‹ç”¨æˆ¶ç¨ç«‹è¨­å®šè·Ÿå–®æ¯”ä¾‹
- å¯éš¨æ™‚å•Ÿç”¨/åœç”¨è·Ÿå–®
- æ”¯æ´å‹•æ…‹èª¿æ•´é…ç½®

### 2. æ™ºèƒ½ç›£æ§
- åªç›£æ§ `is_active=True` çš„ç”¨æˆ¶
- æ ¹æ“šæ¯å€‹ç”¨æˆ¶çš„æ¯”ä¾‹è¨ˆç®—ä¸‹å–®é‡
- æª¢æ¸¬ Master å€‰ä½è®Šå‹•ä¸¦è‡ªå‹•è·Ÿå–®

### 3. é˜²éŒ¯æ©Ÿåˆ¶
- äº¤æ˜“å¤±æ•—æ™‚è‡ªå‹•åœæ­¢è·Ÿå–®
- è¨˜éŒ„è©³ç´°éŒ¯èª¤è³‡è¨Š
- é˜²æ­¢é€£çºŒå¤±æ•—é€ æˆæå¤±

### 4. éŒ¯èª¤æ¢å¾©
- æŸ¥çœ‹æ‰€æœ‰éŒ¯èª¤è¨˜éŒ„
- æ‰‹å‹•è§£æ±ºéŒ¯èª¤
- ç„¡æœªè§£æ±ºéŒ¯èª¤æ™‚è‡ªå‹•æ¢å¾©è·Ÿå–®

### 5. ç‹€æ…‹å„€è¡¨æ¿
- æŸ¥çœ‹ç•¶å‰è·Ÿå–®ç‹€æ…‹
- å°æ¯” Master å’Œè‡ªå·±çš„å€‰ä½
- é¡¯ç¤ºé æœŸè·Ÿå–®æ•¸é‡
- é¡¯ç¤ºæœªè§£æ±ºéŒ¯èª¤æ•¸é‡

## è³‡æ–™åº«çµæ§‹

### follow_settings è¡¨
```sql
CREATE TABLE follow_settings (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL UNIQUE,
    master_user_id INTEGER NOT NULL,
    master_credential_id INTEGER NOT NULL,
    follower_credential_id INTEGER NOT NULL,
    follow_ratio FLOAT NOT NULL DEFAULT 0.1,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (master_user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (master_credential_id) REFERENCES api_credentials(id) ON DELETE CASCADE,
    FOREIGN KEY (follower_credential_id) REFERENCES api_credentials(id) ON DELETE CASCADE
);
```

### trade_errors è¡¨
```sql
CREATE TABLE trade_errors (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    trade_log_id INTEGER,
    error_type VARCHAR(50) NOT NULL,
    error_message TEXT NOT NULL,
    error_details TEXT,
    is_resolved BOOLEAN NOT NULL DEFAULT FALSE,
    resolved_at TIMESTAMP,
    resolved_by INTEGER,
    created_at TIMESTAMP NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (trade_log_id) REFERENCES trade_logs(id) ON DELETE SET NULL,
    FOREIGN KEY (resolved_by) REFERENCES users(id) ON DELETE SET NULL
);
```

## ç¸½çµ

è·Ÿå–®é…ç½®ç³»çµ±å·²å®Œå…¨å¯¦ä½œä¸¦æ¸¬è©¦å°±ç·’ï¼ç³»çµ±ç¾åœ¨å…·å‚™ï¼š

1. âœ… **ç”¨æˆ¶ç´šåˆ¥çš„è·Ÿå–®é…ç½®** - æ¯å€‹ç”¨æˆ¶ç¨ç«‹è¨­å®š
2. âœ… **å„ªåŒ–çš„ç›£æ§ä»»å‹™** - åªç›£æ§å•Ÿç”¨çš„ç”¨æˆ¶
3. âœ… **è·Ÿå–®ç‹€æ…‹å„€è¡¨æ¿** - å¯¦æ™‚æŸ¥çœ‹è·Ÿå–®ç‹€æ…‹
4. âœ… **é˜²éŒ¯æ©Ÿåˆ¶** - è‡ªå‹•åœæ­¢å¤±æ•—çš„è·Ÿå–®
5. âœ… **éŒ¯èª¤æ¢å¾©** - æ‰‹å‹•è§£æ±ºéŒ¯èª¤å¾Œè‡ªå‹•æ¢å¾©

ç³»çµ±å·²å°±ç·’ï¼Œé–‹å§‹æ¸¬è©¦å§ï¼ğŸš€
