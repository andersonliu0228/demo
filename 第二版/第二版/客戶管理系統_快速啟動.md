# 客戶管理系統 - 快速啟動指南 🚀

## 📋 系統概述

客戶管理系統允許交易員（Master）管理其跟單客戶（Follower），包括：
- 查看所有客戶列表
- 核准待審核的客戶
- 暫停或啟用客戶跟單
- 刪除客戶關係
- 查看客戶淨值與盈虧數據

## 🎯 核心功能

### 1. 客戶列表顯示
- 客戶名稱與郵箱
- 跟單倍率設定
- 當前淨值
- 盈虧金額與百分比
- 狀態標籤（已啟用/待核准/已封鎖）

### 2. 客戶管理操作
- **核准**: 將待核准客戶設為已啟用
- **暫停**: 將已啟用客戶設為已封鎖
- **啟用**: 將已封鎖客戶重新啟用
- **刪除**: 永久刪除客戶關係

### 3. 統計儀表板
- 總客戶數
- 已啟用客戶數
- 待核准客戶數
- 已封鎖客戶數

## 🚀 快速啟動

### 步驟 1: 啟動系統

```powershell
# 啟動所有容器
docker-compose up -d

# 等待容器啟動完成（約 30 秒）
Start-Sleep -Seconds 30
```

### 步驟 2: 執行資料庫遷移

```powershell
# 執行遷移以創建 follower_relations 表
docker exec ea_trading_backend alembic upgrade head
```

### 步驟 3: 重啟後端

```powershell
# 重啟後端以載入新模型
docker-compose restart backend
```

### 步驟 4: 訪問系統

1. 打開瀏覽器訪問: `http://localhost:3000`
2. 登入系統（使用現有帳號）
3. 點擊導航欄的「客戶管理」按鈕
4. 查看客戶管理看板

## 🧪 使用測試腳本

我們提供了自動化測試腳本：

```powershell
# 執行測試腳本
.\test-trader-admin.ps1
```

測試腳本會自動：
- 檢查容器狀態
- 執行資料庫遷移
- 重啟後端
- 測試健康檢查
- 顯示訪問資訊

## 📊 Mock 數據說明

系統內建 Mock 數據，即使沒有真實客戶也能看到示範數據：

```javascript
Mock 客戶範例:
- Wilson: 1.0x 倍率, $10,200 淨值, +$200 盈虧, 已啟用
- Tester01: 0.5x 倍率, $5,100 淨值, +$100 盈虧, 待核准
- Alice: 1.5x 倍率, $15,300 淨值, +$300 盈虧, 已啟用
- Bob: 0.8x 倍率, $8,000 淨值, -$200 盈虧, 已封鎖
```

## 🔧 API 端點

### 獲取客戶列表
```http
GET /api/v1/trader/clients
Authorization: Bearer <token>
```

**響應範例**:
```json
[
  {
    "id": 1,
    "relation_id": 1,
    "username": "Wilson",
    "email": "wilson@example.com",
    "copy_ratio": 1.0,
    "status": "active",
    "net_value": 10200.0,
    "pnl": 200.0,
    "pnl_percentage": 2.0,
    "created_at": "2024-01-15T10:00:00"
  }
]
```

### 管理客戶
```http
POST /api/v1/trader/manage-client
Authorization: Bearer <token>
Content-Type: application/json

{
  "relation_id": 1,
  "action": "approve"  // approve, block, delete
}
```

## 🎨 頁面功能說明

### 統計卡片區域
位於頁面頂部，顯示四個統計卡片：
- **總客戶數**: 所有客戶總數
- **已啟用**: 綠色，正在跟單的客戶
- **待核准**: 黃色，等待核准的客戶
- **已封鎖**: 紅色，已暫停的客戶

### 客戶表格
顯示所有客戶的詳細資訊：
- **客戶名稱**: 顯示頭像（首字母）、用戶名、郵箱
- **跟單倍率**: 例如 1.0x, 0.5x
- **當前淨值**: 格式化為美元金額
- **盈虧**: 顯示金額和百分比，綠色為正，紅色為負
- **狀態**: 彩色徽章顯示當前狀態
- **動作**: 根據狀態顯示不同按鈕

### 動作按鈕邏輯
- **待核准狀態**: 顯示「核准」和「刪除」
- **已啟用狀態**: 顯示「暫停」和「刪除」
- **已封鎖狀態**: 顯示「啟用」和「刪除」

## 🔍 故障排除

### 問題 1: 頁面顯示空白
**解決方案**:
```powershell
# 檢查前端容器日誌
docker logs ea_trading_frontend

# 重啟前端容器
docker-compose restart frontend
```

### 問題 2: API 返回 401 錯誤
**解決方案**:
- 確認已登入
- 檢查 Token 是否過期
- 重新登入系統

### 問題 3: 客戶列表為空
**解決方案**:
- 系統會自動顯示 Mock 數據
- 如果仍為空，檢查瀏覽器控制台錯誤
- 確認後端 API 正常運行

### 問題 4: 資料庫遷移失敗
**解決方案**:
```powershell
# 檢查當前遷移版本
docker exec ea_trading_backend alembic current

# 查看遷移歷史
docker exec ea_trading_backend alembic history

# 強制升級到最新版本
docker exec ea_trading_backend alembic upgrade head
```

## 📝 開發說明

### 新增真實客戶數據

如需新增真實客戶關係，可以直接操作資料庫：

```sql
INSERT INTO follower_relations (master_id, follower_id, copy_ratio, status)
VALUES (1, 2, 1.0, 'pending');
```

或使用 Python 腳本：

```python
from backend.app.models import FollowerRelation
from backend.app.database import get_db

# 創建新關係
relation = FollowerRelation(
    master_id=1,
    follower_id=2,
    copy_ratio=1.0,
    status='pending'
)
db.add(relation)
db.commit()
```

### 自訂 Mock 數據

編輯 `frontend/src/pages/TraderAdmin.jsx` 中的 `mockClients` 陣列：

```javascript
const mockClients = [
  {
    id: 1,
    relation_id: 1,
    username: '自訂名稱',
    email: 'custom@example.com',
    copy_ratio: 1.0,
    status: 'active',
    net_value: 10000,
    pnl: 500,
    pnl_percentage: 5.0,
    created_at: '2024-01-15T10:00:00'
  }
];
```

## 🎯 測試檢查清單

- [ ] 系統啟動成功
- [ ] 資料庫遷移完成
- [ ] 可以訪問登入頁面
- [ ] 登入成功
- [ ] 導航欄顯示「客戶管理」按鈕
- [ ] 點擊後進入客戶管理頁面
- [ ] 統計卡片顯示正確
- [ ] 客戶表格顯示 Mock 數據
- [ ] 可以點擊「核准」按鈕
- [ ] 可以點擊「暫停」按鈕
- [ ] 可以點擊「刪除」按鈕（需確認）
- [ ] 操作後頁面自動刷新

## 📚 相關文件

- `客戶管理系統實作完成.md` - 完整實作說明
- `backend/app/models/follower_relation.py` - 資料模型
- `backend/app/routes/trader_routes.py` - API 路由
- `frontend/src/pages/TraderAdmin.jsx` - 前端頁面
- `alembic/versions/009_add_follower_relations.py` - 資料庫遷移

## 🎉 完成！

系統已完全實作並可以使用。如有任何問題，請參考故障排除章節或查看相關文件。
